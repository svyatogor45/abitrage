# План разработки арбитражного веб-терминала

## Обзор

Данный документ содержит пошаговый план разработки проекта, разбитый по приоритетам. План основан на документах **Архитектура.md** и **Тз.md**.

### Условные обозначения

| Символ | Значение |
|--------|----------|
| `[ ]` | Не начато |
| `[~]` | В процессе |
| `[x]` | Завершено |
| `[!]` | Заблокировано |

---

## Приоритет 1: Базовая инфраструктура (КРИТИЧЕСКИЙ)

> **Цель:** Создать фундамент проекта — конфигурация, БД, базовые модели и HTTP сервер.

### 1.1 Конфигурация и запуск

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Структура конфигурации | `internal/config/config.go` | Загрузка переменных окружения, валидация, значения по умолчанию |
| `[x]` | Пример .env файла | `.env.example` | Шаблон переменных окружения |
| `[x]` | Go модули | `go.mod` | Зависимости проекта |
| `[ ]` | Генерация go.sum | `go.sum` | Выполнить `go mod tidy` |

### 1.2 База данных и миграции

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Таблица exchanges | `migrations/001_*.sql` | Хранение API ключей бирж |
| `[x]` | Таблица pairs | `migrations/002_*.sql` | Конфигурация торговых пар |
| `[x]` | Таблица orders | `migrations/003_*.sql` | История ордеров |
| `[x]` | Таблица notifications | `migrations/004_*.sql` | Журнал уведомлений |
| `[x]` | Таблица settings | `migrations/005_*.sql` | Глобальные настройки |
| `[x]` | Таблица blacklist | `migrations/006_*.sql` | Черный список пар |
| `[x]` | Таблица trades | `migrations/007_*.sql` | Завершенные арбитражи (статистика) |

### 1.3 Модели данных

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeAccount | `internal/models/exchange_account.go` | Модель биржевого аккаунта |
| `[x]` | PairConfig | `internal/models/pair.go` | Конфигурация торговой пары |
| `[x]` | PairRuntime | `internal/models/pair_runtime.go` | Runtime состояние пары (Leg) |
| `[x]` | OrderRecord | `internal/models/order.go` | Запись об ордере |
| `[x]` | Notification | `internal/models/notification.go` | Уведомление о событии |
| `[x]` | Settings | `internal/models/settings.go` | Глобальные настройки |
| `[x]` | BlacklistEntry | `internal/models/blacklist.go` | Запись черного списка |
| `[x]` | Stats | `internal/models/stats.go` | Агрегированная статистика |

### 1.4 Точка входа и HTTP сервер

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Main функция | `cmd/server/main.go` | Инициализация, graceful shutdown |
| `[x]` | Маршрутизация | `internal/api/routes.go` | Регистрация всех HTTP маршрутов |
| `[x]` | CORS middleware | `internal/api/middleware/cors.go` | Настройка CORS заголовков |
| `[x]` | Logging middleware | `internal/api/middleware/logging.go` | Логирование HTTP запросов |
| `[x]` | Recovery middleware | `internal/api/middleware/recovery.go` | Восстановление после паники |
| `[x]` | Auth middleware | `internal/api/middleware/auth.go` | JWT аутентификация |

### 1.5 Docker и деплой

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Dockerfile | `Dockerfile` | Сборка Go приложения |
| `[x]` | Docker Compose | `docker-compose.yml` | Оркестрация сервисов |

---

## Приоритет 2: Утилиты и вспомогательные пакеты (ВЫСОКИЙ)

> **Цель:** Реализовать переиспользуемые библиотеки для шифрования, логирования, retry логики.

### 2.1 Криптография

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | AES-256 шифрование | `pkg/crypto/encrypt.go` | Encrypt/Decrypt для API ключей |
| `[x]` | Bcrypt хеширование | `pkg/crypto/hash.go` | Хеширование паролей |

### 2.2 Утилиты

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Математические функции | `pkg/utils/math.go` | RoundToLotSize, CalculateSpread, CalculateNetSpread |
| `[x]` | Логирование | `pkg/utils/logger.go` | Структурированное логирование (zap/logrus) |
| `[x]` | Работа со временем | `pkg/utils/time.go` | GetDayStart, GetWeekStart, GetMonthStart |
| `[x]` | Валидация | `pkg/utils/validator.go` | ValidateSymbol, ValidateSpread, ValidateVolume |

### 2.3 Retry и Rate Limiting

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Retry механизм | `pkg/retry/retry.go` | Экспоненциальный backoff (2s, 4s, 8s, 16s) |
| `[x]` | Rate limiter | `pkg/ratelimit/limiter.go` | Token Bucket для контроля частоты запросов |

---

## Приоритет 3: Интеграция с биржами (ВЫСОКИЙ)

> **Цель:** Реализовать унифицированный интерфейс для работы с биржами и коннекторы к каждой бирже.

### 3.1 Общий интерфейс

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Exchange interface | `internal/exchange/interface.go` | Унифицированный интерфейс (Connect, GetBalance, PlaceMarketOrder, etc.) |
| `[x]` | Exchange factory | `internal/exchange/factory.go` | NewExchange(name) - создание экземпляра биржи |

### 3.2 Реализации для бирж

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Bybit коннектор | `internal/exchange/bybit.go` | Bybit API v5, WebSocket |
| `[x]` | Bitget коннектор | `internal/exchange/bitget.go` | Bitget Futures API |
| `[x]` | OKX коннектор | `internal/exchange/okx.go` | OKX Futures API (+ passphrase) |
| `[x]` | Gate.io коннектор | `internal/exchange/gate.go` | Gate.io Futures API |
| `[x]` | HTX коннектор | `internal/exchange/htx.go` | HTX Linear Swaps API |
| `[x]` | BingX коннектор | `internal/exchange/bingx.go` | BingX Perpetual Futures API |

### 3.3 Функциональность каждого коннектора

Для каждой биржи (Bybit, Bitget, OKX, Gate.io, HTX, BingX) реализовано:

- [x] `Connect(apiKey, secret string) error` - подключение и проверка ключей
- [x] `GetBalance() (float64, error)` - получение equity в USDT
- [x] `GetTicker(symbol string) (Ticker, error)` - текущая цена
- [x] `GetOrderBook(symbol string, depth int) (OrderBook, error)` - стакан ордеров
- [x] `PlaceMarketOrder(symbol, side string, qty float64) (Order, error)` - рыночный ордер
- [x] `GetOpenPositions() ([]Position, error)` - открытые позиции
- [x] `ClosePosition(symbol, side string, qty float64) error` - закрытие позиции
- [x] `SubscribeTicker(symbol string, callback func(Ticker))` - WebSocket подписка
- [x] `GetTradingFee(symbol string) (float64, error)` - комиссия тейкера
- [x] `GetLimits(symbol string) (Limits, error)` - лимиты биржи (min/max)

---

## Приоритет 4: Репозитории (Data Access Layer) (ВЫСОКИЙ)

> **Цель:** Реализовать слой доступа к данным для всех сущностей.

### 4.1 CRUD репозитории

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeRepository | `internal/repository/exchange_repository.go` | CRUD для бирж, UpdateBalance |
| `[x]` | PairRepository | `internal/repository/pair_repository.go` | CRUD для пар, GetActive, UpdateStatus |
| `[x]` | OrderRepository | `internal/repository/order_repository.go` | CRUD для ордеров, GetByPairID |
| `[x]` | NotificationRepository | `internal/repository/notification_repository.go` | CRUD, GetByTypes, DeleteOlderThan |
| `[x]` | SettingsRepository | `internal/repository/settings_repository.go` | Get/Update настроек |
| `[x]` | BlacklistRepository | `internal/repository/blacklist_repository.go` | CRUD, Exists |
| `[x]` | StatsRepository | `internal/repository/stats_repository.go` | GetStats, RecordTrade, RecordStopLoss, RecordLiquidation |

### 4.2 Реализация методов репозиториев

Для каждого репозитория:
- [x] Реализовать SQL запросы
- [x] Обработка ошибок (sql.ErrNoRows, etc.)
- [x] Транзакционная поддержка где необходимо
- [ ] Тесты

---

## Приоритет 5: Сервисный слой (Бизнес-логика) (ВЫСОКИЙ)

> **Цель:** Реализовать бизнес-логику между API и репозиториями.

### 5.1 Сервисы

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeService | `internal/service/exchange_service.go` | ConnectExchange, DisconnectExchange, UpdateBalance |
| `[x]` | PairService | `internal/service/pair_service.go` | CreatePair, UpdatePair, StartPair, PausePair |
| `[x]` | StatsService | `internal/service/stats_service.go` | GetStats, GetTopPairs, ResetStats, RecordTradeCompletion (полностью реализовано) |
| `[x]` | NotificationService | `internal/service/notification_service.go` | CreateNotification, GetNotifications, ClearNotifications |
| `[x]` | RiskService | `internal/service/risk_service.go` | CheckStopLoss, CheckMarginRequirement, HandleLiquidation |

### 5.2 Ключевая логика сервисов

**ExchangeService:**
- [x] Шифрование API ключей перед сохранением
- [x] Тестовое подключение при ConnectExchange
- [x] Остановка пар при DisconnectExchange

**PairService:**
- [x] Валидация параметров (спреды > 0, объем > 0)
- [x] Проверка доступности актива на ≥2 биржах
- [x] Отложенное применение изменений при открытой позиции
- [x] Принудительное закрытие при PausePair с forceClose=true

**NotificationService:**
- [x] Проверка настроек уведомлений перед созданием
- [ ] Broadcast через WebSocket Hub (ожидает реализации WebSocket типов сообщений)

---

## Приоритет 6: REST API Handlers (ВЫСОКИЙ)

> **Цель:** Реализовать HTTP обработчики для всех endpoints.

### 6.1 Handlers

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeHandler | `internal/api/handlers/exchange_handler.go` | POST/DELETE /exchanges/{name}/connect, GET /exchanges |
| `[x]` | PairHandler | `internal/api/handlers/pair_handler.go` | CRUD /pairs, /pairs/{id}/start, /pairs/{id}/pause (полностью реализовано) |
| `[x]` | NotificationHandler | `internal/api/handlers/notification_handler.go` | GET/DELETE /notifications |
| `[x]` | StatsHandler | `internal/api/handlers/stats_handler.go` | GET /stats, POST /stats/reset |
| `[x]` | BlacklistHandler | `internal/api/handlers/blacklist_handler.go` | CRUD /blacklist (полностью реализовано) |
| `[x]` | SettingsHandler | `internal/api/handlers/settings_handler.go` | GET/PATCH /settings |

### 6.2 Реализация endpoints

**Exchanges:**
- [x] `POST /api/exchanges/{name}/connect` - подключение биржи
- [x] `DELETE /api/exchanges/{name}/connect` - отключение биржи
- [x] `GET /api/exchanges` - список бирж и статусов
- [x] `GET /api/exchanges/{name}/balance` - обновление баланса

**Pairs:**
- [x] `POST /api/pairs` - добавление пары
- [x] `GET /api/pairs` - список всех пар
- [x] `GET /api/pairs/{id}` - конкретная пара
- [x] `PATCH /api/pairs/{id}` - редактирование пары
- [x] `DELETE /api/pairs/{id}` - удаление пары
- [x] `POST /api/pairs/{id}/start` - запуск мониторинга
- [x] `POST /api/pairs/{id}/pause` - приостановка

**Notifications:**
- [x] `GET /api/notifications` - список уведомлений
- [x] `GET /api/notifications?types=open,close,error` - с фильтрацией
- [x] `DELETE /api/notifications` - очистка журнала

**Stats:**
- [x] `GET /api/stats` - агрегированная статистика
- [x] `GET /api/stats/top-pairs` - топ-5 пар
- [x] `POST /api/stats/reset` - сброс счетчиков

**Blacklist:**
- [x] `GET /api/blacklist` - черный список
- [x] `POST /api/blacklist` - добавление в ЧС
- [x] `DELETE /api/blacklist/{symbol}` - удаление из ЧС

**Settings:**
- [x] `GET /api/settings` - глобальные настройки
- [x] `PATCH /api/settings` - обновление настроек

---

## Приоритет 7: WebSocket (ВЫСОКИЙ)

> **Цель:** Реализовать real-time коммуникацию между сервером и клиентами.

### 7.1 WebSocket инфраструктура

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | WebSocket Hub | `internal/websocket/hub.go` | Центральный менеджер соединений, broadcast |
| `[x]` | WebSocket Client | `internal/websocket/client.go` | Управление индивидуальным соединением |

### 7.2 Типы сообщений

- [ ] `pairUpdate` - обновление состояния пары (цены, PNL, спред) - каждую секунду
- [ ] `notification` - новое уведомление
- [ ] `balanceUpdate` - обновление баланса биржи - каждую минуту
- [ ] `statsUpdate` - обновление статистики

### 7.3 Функциональность

- [x] Регистрация/отмена регистрации клиентов
- [x] Ping/Pong для проверки живости соединения
- [x] Буферизация исходящих сообщений (оптимизировано: исправлен race condition)
- [x] Graceful закрытие соединений
- [ ] Обработка переподключений

> **Оптимизации:**
> - maxMessageSize увеличен с 512 до 65536 байт
> - Исправлен race condition в writePump при чтении из буфера
> - Увеличены ReadBufferSize/WriteBufferSize до 4096 байт

---

## Приоритет 8: Торговый движок (Бот) (КРИТИЧЕСКИЙ)

> **Цель:** Реализовать основную торговую логику арбитражного бота.

### 8.1 Core компоненты бота

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Engine | `internal/bot/engine.go` | Главный event loop, координация |
| `[x]` | State Machine | `internal/bot/state_machine.go` | Состояния пары (PAUSED, READY, ENTERING, HOLDING, EXITING, ERROR) |
| `[x]` | Arbitrage | `internal/bot/arbitrage.go` | Логика принятия решений об арбитраже |
| `[x]` | Spread Calculator | `internal/bot/spread.go` | Расчет спреда с учетом комиссий |
| `[x]` | Order Executor | `internal/bot/order.go` | Исполнение ордеров на биржах |
| `[x]` | Position Manager | `internal/bot/position.go` | Сопровождение открытых позиций |
| `[x]` | Risk Manager | `internal/bot/risk.go` | SL, ликвидации, проверка маржи |
| `[x]` | Recovery | `internal/bot/recovery.go` | Восстановление после перезапуска |

### 8.2 Engine (Главный движок)

**Функциональность:**
- [x] Главный event loop (event-driven архитектура)
- [x] Обработка всех активных пар
- [x] Координация между компонентами
- [x] Периодическое обновление балансов (каждую минуту)
- [x] Graceful shutdown
- [x] Соблюдение лимита max_concurrent_trades

> **Оптимизации:**
> - Event-driven вместо polling (мгновенная реакция на цены)
> - Шардированный worker pool для параллельной обработки
> - sync.Map для lock-free доступа к pairsBySymbol
> - Atomic counter для activeArbs (без mutex)
> - broadcastPairStates оптимизирован (короткий RLock)

### 8.3 State Machine (Машина состояний)

**Состояния:**
```
PAUSED     → пара на паузе
READY      → мониторинг активен, ожидание условий
ENTERING   → процесс входа в позицию
HOLDING    → позиция открыта, ожидание выхода
EXITING    → процесс закрытия позиции
ERROR      → ошибка, требуется вмешательство
```

**Переходы:**
- [ ] PAUSED → READY (start)
- [ ] READY → ENTERING (условия входа выполнены)
- [ ] ENTERING → HOLDING (обе ноги открыты)
- [ ] ENTERING → PAUSED (ошибка второй ноги)
- [ ] HOLDING → EXITING (условия выхода)
- [ ] HOLDING → PAUSED (SL или ликвидация)
- [ ] EXITING → READY (успешное закрытие)
- [ ] Любое → ERROR → PAUSED

### 8.4 Spread Calculator (Расчет спреда)

**Функциональность:**
- [ ] Получение цен со всех подключенных бирж
- [ ] Анализ стакана ордеров (5 уровней глубины)
- [ ] Моделирование исполнения ордера заданного объема
- [ ] Расчет базового спреда: `(P_high - P_low) / P_low × 100`
- [ ] Учет комиссий тейкера на обеих биржах
- [ ] Расчет чистого спреда (net spread)
- [ ] Проверка достаточности ликвидности
- [ ] Кэширование данных стаканов

### 8.5 Arbitrage (Логика арбитража)

**Функциональность:**
- [ ] Определение арбитражных возможностей
- [ ] Выбор оптимальной пары бирж (min price / max price)
- [ ] Проверка условий входа: `net_spread ≥ entry_spread`
- [ ] Проверка условий выхода: `spread ≤ exit_spread`
- [ ] Логика частичного входа (разбиение на N ордеров)
- [ ] Координация одновременного открытия/закрытия позиций
- [ ] Обработка кейса "вторая нога не открылась"

### 8.6 Order Executor (Исполнение ордеров)

**Функциональность:**
- [ ] Формирование рыночных ордеров
- [ ] Одновременная отправка на две биржи (асинхронно)
- [ ] Ожидание подтверждения исполнения
- [ ] Получение средней цены исполнения (fill price)
- [ ] Обработка частичного исполнения
- [ ] Retry logic при ошибках API (до 4 попыток)
- [ ] Валидация размеров ордеров (min/max limits)
- [ ] Округление объемов до lot size биржи

### 8.7 Position Manager (Сопровождение позиций)

**Функциональность:**
- [x] Непрерывный мониторинг открытых позиций
- [x] Получение текущих цен для расчета unrealized PNL
- [x] Расчет PNL по каждой ноге: `(P_current - P_entry) × qty`
- [x] Суммирование PNL обеих ног арбитража
- [x] Отслеживание текущего спреда между позициями
- [x] Проверка условий для закрытия позиций
- [x] Обновление данных в WebSocket (каждую секунду)

### 8.8 Risk Manager (Управление рисками)

**Функциональность:**
- [x] Мониторинг Stop Loss: `total_PNL ≤ -SL`
- [x] Автоматическое закрытие при достижении SL
- [x] Обнаружение ликвидаций через WebSocket биржи
- [x] Экстренное закрытие второй ноги при ликвидации первой
- [ ] Автоматическая постановка пары на паузу после SL/ликвидации
- [ ] Проверка маржинальных требований перед входом
- [ ] Расчет margin requirement для позиции
- [ ] Генерация уведомлений о критических событиях

### 8.9 Recovery (Восстановление)

**Функциональность:**
- [ ] Чтение конфигурации из БД при старте
- [ ] Восстановление подключений к биржам
- [ ] Обнаружение открытых позиций через API бирж
- [ ] Попытка идентификации позиций бота
- [ ] Восстановление runtime состояния пар
- [ ] Уведомление пользователя о найденных позициях
- [ ] Опциональное автоматическое закрытие "потерянных" позиций

---

## Приоритет 9: Frontend (React) (СРЕДНИЙ)

> **Цель:** Создать веб-интерфейс для управления ботом.

### 9.1 Базовая структура

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | Инициализация проекта | `frontend/` | Create React App или Vite с TypeScript |
| `[x]` | package.json | `frontend/package.json` | Зависимости (React, TypeScript, Axios, etc.) |
| `[x]` | tsconfig.json | `frontend/tsconfig.json` | Настройки TypeScript |
| `[x]` | Типы | `frontend/src/types/index.ts` | TypeScript интерфейсы |

### 9.2 Сервисы

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | API клиент | `frontend/src/services/api.ts` | Axios HTTP клиент |
| `[x]` | WebSocket клиент | `frontend/src/services/websocket.ts` | Подключение к WS |

### 9.3 Хуки

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | usePairs | `frontend/src/hooks/usePairs.ts` | Работа с парами |
| `[x]` | useExchanges | `frontend/src/hooks/useExchanges.ts` | Работа с биржами |
| `[x]` | useWebSocket | `frontend/src/hooks/useWebSocket.ts` | WebSocket соединение |
| `[x]` | useNotifications | `frontend/src/hooks/useNotifications.ts` | Работа с уведомлениями |

### 9.4 Общие компоненты

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | Header | `frontend/src/components/Common/Header.tsx` | Шапка приложения |
| `[x]` | Navigation | `frontend/src/components/Common/Navigation.tsx` | Навигация по вкладкам |
| `[x]` | BalanceBar | `frontend/src/components/Common/BalanceBar.tsx` | Балансы бирж |

### 9.5 Вкладка БОТ

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | BotPage | `frontend/src/pages/BotPage.tsx` | Главная страница бота |
| `[x]` | PairCard | `frontend/src/components/Bot/PairCard.tsx` | Карточка торговой пары |
| `[x]` | AddPairModal | `frontend/src/components/Bot/AddPairModal.tsx` | Модальное окно добавления |
| `[x]` | EditPairModal | `frontend/src/components/Bot/EditPairModal.tsx` | Редактирование пары |
| `[x]` | Blacklist | `frontend/src/components/Bot/Blacklist.tsx` | Черный список |

**Функциональность PairCard:**
- [x] Цветовая индикация (зеленый/оранжевый/белый)
- [x] Отображение параметров (Р.О, С.В, С.ВЫ, N.ОР, SL)
- [x] Текущие позиции (биржа, side, цена, PNL)
- [x] Суммарный PNL по связке
- [x] Кнопки: Старт/Пауза, Изменить, Удалить
- [x] Обновление данных каждую секунду (через WebSocket)

### 9.6 Вкладка API/STATS

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | APIStatsPage | `frontend/src/pages/APIStatsPage.tsx` | Страница API и статистики |
| `[x]` | ExchangeList | `frontend/src/components/API/ExchangeList.tsx` | Список бирж |
| `[x]` | ExchangeCard | `frontend/src/components/API/ExchangeCard.tsx` | Карточка биржи |
| `[x]` | StatsOverview | `frontend/src/components/Stats/StatsOverview.tsx` | Обзор статистики |
| `[x]` | TopPairs | `frontend/src/components/Stats/TopPairs.tsx` | Топ-5 пар |
| `[x]` | EventsList | `frontend/src/components/Stats/EventsList.tsx` | Список SL/ликвидаций |

**Функциональность ExchangeCard:**
- [x] Логотип биржи
- [x] Статус подключения (зеленый/красный)
- [x] Поля для API Key и Secret
- [x] Кнопки: Подключить/Изменить/Отключить
- [x] Отображение баланса (equity)

**Функциональность StatsOverview:**
- [x] Количество сделок (день/неделя/месяц)
- [x] Общий PNL (день/неделя/месяц)
- [x] Счетчик SL (с деталями)
- [x] Счетчик ликвидаций (с деталями)
- [x] Кнопки сброса счетчиков
- [x] Интеграция WebSocket для real-time обновлений

### 9.7 Вкладка Уведомления

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | NotificationsPage | `frontend/src/pages/NotificationsPage.tsx` | Страница уведомлений |
| `[x]` | NotificationFeed | `frontend/src/components/Notifications/NotificationFeed.tsx` | Лента уведомлений |
| `[x]` | NotificationFilters | `frontend/src/components/Notifications/NotificationFilters.tsx` | Фильтры по типам |

**Типы уведомлений:**
- [x] OPEN - открытие сделки (зеленый)
- [x] CLOSE - закрытие сделки (зеленый)
- [x] SL - Stop Loss (красный)
- [x] LIQUIDATION - ликвидация (красный)
- [x] ERROR - ошибка API (красный)
- [x] MARGIN - недостаток маржи (желтый)
- [x] PAUSE - пауза/остановка (желтый)
- [x] SECOND_LEG_FAIL - вторая нога не открыта (красный)
- [x] Интеграция WebSocket для real-time уведомлений

### 9.8 Главное приложение

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | App | `frontend/src/App.tsx` | Главный компонент с роутингом |
| `[x]` | index | `frontend/src/index.tsx` | Точка входа |
| `[x]` | Индикатор статуса WebSocket | `frontend/src/components/Common/Header.tsx` | Отображение статуса соединения |

---

## Приоритет 10: Тестирование (СРЕДНИЙ)

> **Цель:** Обеспечить качество кода через тестирование.

### 10.1 Unit тесты

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | Тесты моделей | Валидация структур данных |
| `[ ]` | Тесты репозиториев | Mock БД, CRUD операции |
| `[ ]` | Тесты сервисов | Mock репозиториев |
| `[ ]` | Тесты handlers | Mock сервисов, HTTP запросы |
| `[ ]` | Тесты spread calculator | Расчет спреда с разными данными |
| `[ ]` | Тесты state machine | Переходы между состояниями |
| `[ ]` | Тесты crypto | Шифрование/дешифрование |

### 10.2 Интеграционные тесты

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | API integration tests | Полный цикл запросов |
| `[ ]` | WebSocket tests | Подключение, broadcast |
| `[ ]` | Database tests | Миграции, транзакции |

### 10.3 E2E тесты (опционально)

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | Cypress/Playwright | Тестирование UI |
| `[ ]` | Сценарии пользователя | Добавление пары, старт/пауза |

---

## Приоритет 11: Документация и финализация (НИЗКИЙ)

> **Цель:** Документирование и подготовка к production.

### 11.1 Документация

| Статус | Задача | Описание |
|--------|--------|----------|
| `[x]` | README.md | Описание проекта, инструкции запуска |
| `[x]` | Архитектура.md | Архитектурная документация |
| `[ ]` | API документация | Swagger/OpenAPI спецификация |
| `[ ]` | Руководство пользователя | Как пользоваться терминалом |

### 11.2 Production готовность

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | SSL/TLS сертификаты | HTTPS настройка |
| `[ ]` | Nginx reverse proxy | Production конфигурация |
| `[ ]` | Мониторинг и алерты | Prometheus/Grafana (опционально) |
| `[ ]` | Backup стратегия | Резервное копирование БД |
| `[ ]` | Rate limit tuning | Настройка лимитов для каждой биржи |

---

## Порядок выполнения (Roadmap)

### Фаза 1: Фундамент (1-2 недели)
1. ✅ Приоритет 1 (Базовая инфраструктура)
2. ✅ Приоритет 2 (Утилиты)
3. ✅ Приоритет 3.1 (Интерфейс бирж)

### Фаза 2: Backend Core (2-3 недели)
4. Приоритет 3.2 (Реализации коннекторов бирж)
5. Приоритет 4 (Репозитории - реализация SQL)
6. Приоритет 5 (Сервисный слой - реализация логики)
7. Приоритет 6 (REST API - реализация endpoints)

### Фаза 3: Торговый движок (2-3 недели)
8. Приоритет 7 (WebSocket)
9. Приоритет 8 (Торговый движок - Bot)

### Фаза 4: Frontend (2-3 недели)
10. Приоритет 9 (React приложение)

### Фаза 5: Тестирование и релиз (1-2 недели)
11. Приоритет 10 (Тестирование)
12. Приоритет 11 (Документация и production)

---

## Зависимости между компонентами

```
Config → Models → Repositories → Services → Handlers → Routes
                      ↓
                  Bot Engine
                      ↓
              Exchange Connectors
                      ↓
                WebSocket Hub → Frontend
```

---

## Критические пути

1. **Exchange Connectors** - без них невозможна торговля
2. **Bot Engine** - ядро системы
3. **WebSocket** - real-time обновления для UI
4. **State Machine** - корректные переходы между состояниями

---

## Требования к производительности торгового ядра

> **Принцип:** Торговое ядро НЕ должно быть узким местом системы. Основные задержки должны приходиться на сетевые операции биржевых API.

### Критические метрики латентности (SLA)

| Операция | Целевое время | Критическое |
|----------|---------------|-------------|
| Tick → Order (внутри кода) | < 5ms | > 50ms |
| Обработка одного PriceUpdate | < 1ms | > 10ms |
| Расчёт спреда и проверка условий | < 0.5ms | > 5ms |
| Пересчёт лучших цен (PriceTracker) | O(k), k~6 | O(n²) |

### Чеклист оптимизаций торгового ядра

#### Архитектурные требования

| Статус | Требование | Описание |
|--------|------------|----------|
| `[x]` | Event-driven (НЕ polling) | Мгновенная реакция на события WebSocket |
| `[x]` | Шардирование по символам | Разные символы не блокируют друг друга |
| `[x]` | sync.Map для hot path | Lock-free чтение в критическом пути |
| `[x]` | atomic счётчики | activeArbs и другие счётчики через atomic |
| `[x]` | Параллельная отправка ордеров | Время = max(A, B), не сумма |
| `[ ]` | sync.Pool для объектов | Zero-allocation в hot path |

#### Требования к памяти и GC

| Статус | Требование | Описание |
|--------|------------|----------|
| `[ ]` | Object pooling | sync.Pool для PriceUpdate, BestPrices, OrderParams |
| `[ ]` | Предаллокация слайсов | make([]T, 0, capacity) |
| `[x]` | Буферизованные каналы | Размер 2000 на шард |
| `[ ]` | Struct keys вместо строк | Избегание string concatenation |

#### Требования к конкурентности

| Статус | Требование | Описание |
|--------|------------|----------|
| `[x]` | Worker pool с шардами | NumCPU шардов, 2 workers на шард |
| `[x]` | Один символ → один шард | Последовательная обработка без race conditions |
| `[x]` | RWMutex < 1ms | Копирование под Lock, обработка вне Lock |
| `[x]` | broadcastPairStates оптимизирован | Короткий RLock на копирование |

#### Требования к сетевым операциям

| Статус | Требование | Описание |
|--------|------------|----------|
| `[x]` | WebSocket для цен | Не REST polling |
| `[ ]` | HTTP Keep-Alive | Connection pooling для API |
| `[x]` | Retry с exponential backoff | 2s, 4s, 8s, 16s, не блокирует |
| `[ ]` | Timeout на все операции | Connect 5s, Read/Write 10s, Total 30s |

#### Мониторинг производительности

| Статус | Требование | Описание |
|--------|------------|----------|
| `[ ]` | Метрики латентности | p50, p95, p99 для каждого этапа |
| `[ ]` | Счётчики событий | events/sec, overflows, retries |
| `[ ]` | pprof endpoints | /debug/pprof/* для авторизованных |
| `[ ]` | Алерты | Tick→Order > 10ms warning, > 50ms critical |

### Конфигурируемые параметры

```go
type PerformanceConfig struct {
    // Worker pool
    NumShards       int           `default:"runtime.NumCPU()" min:"4" max:"32"`
    WorkersPerShard int           `default:"2" min:"1" max:"8"`
    ChannelBuffer   int           `default:"2000" min:"100" max:"10000"`

    // Timeouts
    ConnectTimeout  time.Duration `default:"5s"`
    ReadTimeout     time.Duration `default:"10s"`
    WriteTimeout    time.Duration `default:"10s"`
    TotalTimeout    time.Duration `default:"30s"`

    // Retry
    MaxRetries      int           `default:"4"`
    InitialDelay    time.Duration `default:"2s"`
    MaxDelay        time.Duration `default:"16s"`

    // Background tasks (не влияют на торговлю)
    BalanceInterval time.Duration `default:"60s" min:"30s" max:"300s"`
    StatsInterval   time.Duration `default:"60s" min:"10s" max:"300s"`
}
```

### Hot Path (критический путь)

```
WebSocket Tick → Parse → Dispatch → Shard → Spread Calc → Condition Check → Order Build → API Call
     ↓            ↓        ↓         ↓          ↓              ↓               ↓           ↓
  < 0.1ms     < 0.1ms   < 0.1ms   < 0.1ms    < 0.5ms        < 0.1ms         < 0.2ms     < 0.5ms

  ИТОГО внутри кода: < 1.5ms (резерв до 5ms)
```

**Правила для hot path:**
- ❌ Никаких блокирующих операций
- ❌ Никаких аллокаций (использовать sync.Pool)
- ❌ Никаких string concatenation
- ❌ Никаких логов уровня DEBUG (только при ошибках)
- ✅ atomic операции вместо mutex где возможно
- ✅ sync.Map для concurrent read
- ✅ Копирование под коротким Lock

### Антипаттерны (что НЕ делать)

```go
// ❌ Polling с задержкой
for {
    prices := fetchAllPrices()
    time.Sleep(100 * time.Millisecond)
}

// ❌ Длинный Lock
e.mu.Lock()
for _, pair := range e.pairs {
    // долгая обработка...
}
e.mu.Unlock()

// ❌ String concatenation в hot path
key := exchange + ":" + symbol  // аллокация!

// ❌ Последовательная отправка ордеров
result1 := sendOrder(exchange1)  // ждём
result2 := sendOrder(exchange2)  // ещё ждём
// Время = A + B
```

### Правильные паттерны

```go
// ✅ Event-driven
select {
case price := <-priceChan:
    handlePrice(price)
}

// ✅ Короткий Lock + копирование
e.mu.RLock()
pairs := make([]*PairState, len(e.pairs))
copy(pairs, e.pairs)
e.mu.RUnlock()
// обработка вне Lock

// ✅ Struct key вместо строки
type SymbolKey struct { Exchange, Symbol string }
prices[SymbolKey{exchange, symbol}] = price

// ✅ Параллельная отправка
var wg sync.WaitGroup
wg.Add(2)
go func() { defer wg.Done(); result1 = sendOrder(exchange1) }()
go func() { defer wg.Done(); result2 = sendOrder(exchange2) }()
wg.Wait()
// Время = max(A, B)
```

---

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| API биржи изменился | Средняя | Высокое | Версионирование, мониторинг изменений |
| Rate limits превышены | Высокая | Среднее | Rate limiter, кэширование |
| Потеря соединения | Высокая | Высокое | Retry logic, reconnect, graceful degradation |
| Ликвидация позиции | Низкая | Критическое | Risk manager, уведомления, автозакрытие |
| Сбой сервера | Низкая | Критическое | Recovery механизм, логирование состояний |

---

## Чеклист перед релизом

- [ ] Все миграции применены
- [ ] go.sum сгенерирован (`go mod tidy`)
- [ ] Все тесты проходят
- [ ] API ключи шифруются
- [ ] HTTPS настроен
- [ ] Логирование работает
- [ ] WebSocket стабилен
- [ ] Recovery протестирован
- [ ] Документация актуальна
- [ ] Docker образы собираются
- [ ] Frontend собирается для production

---

## Текущий статус проекта

**Backend (Go):**
- Структура файлов: ✅ 100% создано
- Коннекторы бирж: ✅ 100% реализовано (Bybit, Bitget, OKX, Gate.io, HTX, BingX)
- Репозитории: ✅ 100% реализовано (SQL запросы, обработка ошибок)
- ExchangeService: ✅ 100% реализовано (шифрование, подключение, отключение)
- PairService: ✅ 100% реализовано (валидация, проверка бирж, отложенные изменения, принудительное закрытие)
- NotificationService: ✅ 100% реализовано (CreateNotification, GetNotifications, ClearNotifications, проверка настроек)
- StatsService: ✅ 100% реализовано
- SettingsService: ✅ 100% реализовано
- RiskService: ⏳ Частично реализовано
- REST API Exchanges: ✅ 100% реализовано (4/4 endpoints)
- REST API Pairs: ✅ 100% реализовано (7/7 endpoints)
- REST API Stats: ✅ 100% реализовано (3/3 endpoints)
- REST API Settings: ✅ 100% реализовано (2/2 endpoints)
- REST API Notifications: ✅ 100% реализовано (3/3 endpoints)
- REST API Blacklist: ✅ 100% реализовано (3/3 endpoints)

**Frontend (React):**
- Структура файлов: ✅ 100% создано
- Базовая структура: ✅ 100% (package.json, tsconfig.json, типы)
- Сервисы: ✅ 100% (API клиент, WebSocket клиент)
- Хуки: ✅ 100% (usePairs, useExchanges, useWebSocket, useNotifications)
- Общие компоненты: ✅ 100% (Header с индикатором WebSocket, Navigation, BalanceBar)
- Вкладка БОТ: ✅ 100% (BotPage, PairCard, AddPairModal, EditPairModal, Blacklist)
- Вкладка API/STATS: ✅ 100% (APIStatsPage, ExchangeList, ExchangeCard, StatsOverview с WebSocket, TopPairs, EventsList)
- Вкладка Уведомления: ✅ 100% (NotificationsPage, NotificationFeed, NotificationFilters)
- Главное приложение: ✅ 100% (App с роутингом, index.tsx)
- Интеграция WebSocket: ✅ 100% (real-time обновления для пар, балансов, статистики, уведомлений)

**Следующий шаг:** Реализация WebSocket типов сообщений на backend (Приоритет 7.2) или торгового движка (Приоритет 8)

---

## История оптимизаций

### 2025-12-01: REST API endpoints для Blacklist (Приоритет 6.2)

**Реализовано:**

1. **BlacklistService** (`internal/service/blacklist_service.go`)
   - **AddToBlacklist**: добавление пары в черный список
     * Валидация символа (не пустой)
     * Нормализация символа (верхний регистр)
     * Проверка дубликатов
     * Поддержка опциональной причины (reason)
   - **GetBlacklist**: получение всего черного списка
     * Сортировка по дате (новые сверху)
     * Гарантированный возврат пустого массива вместо nil
   - **RemoveFromBlacklist**: удаление по символу
   - **GetBySymbol**: получение записи по символу
   - **IsBlacklisted**: проверка наличия в ЧС
   - **UpdateReason**: обновление причины
   - **Search**: поиск по части символа
   - **GetCount**: количество записей
   - **ClearAll**: полная очистка списка

2. **BlacklistHandler** (`internal/api/handlers/blacklist_handler.go`)
   - **GET /api/v1/blacklist**: получение черного списка
     * Возвращает массив с total count
     * HTTP коды: 200 OK, 500 Internal Server Error
   - **POST /api/v1/blacklist**: добавление в ЧС
     * Принимает JSON: {symbol, reason}
     * HTTP коды: 201 Created, 400 Bad Request, 409 Conflict, 500 Internal Server Error
   - **DELETE /api/v1/blacklist/{symbol}**: удаление из ЧС
     * HTTP коды: 204 No Content, 400 Bad Request, 404 Not Found, 500 Internal Server Error

3. **Обновление routes.go**:
   - Добавлен BlacklistService в Dependencies
   - BlacklistHandler получает BlacklistService через конструктор
   - Условная регистрация routes (проверка nil)

4. **Обновление main.go**:
   - Инициализация BlacklistRepository
   - Создание BlacklistService с передачей репозитория
   - Передача BlacklistService в Dependencies

**Примечание:** Черный список носит ИНФОРМАТИВНЫЙ характер - это заметки пользователя о нежелательных парах. Бот НЕ фильтрует автоматически на основе этого списка.

---

### 2025-12-01: REST API endpoints для Notifications (Приоритет 6.2)

**Реализовано:**

1. **NotificationService** (`internal/service/notification_service.go`)
   - **CreateNotification**: создание уведомления
     * Проверка настроек уведомлений (notification_prefs) перед созданием
     * Если тип уведомлений отключен - пропускается
     * Fail-safe: при ошибке получения настроек уведомление создается
     * Подготовлено для WebSocket broadcast (TODO)
   - **GetNotifications**: получение списка уведомлений
     * Поддержка фильтрации по типам (types query param)
     * Нормализация типов (приведение к верхнему регистру)
     * Валидация допустимых типов
     * Лимит по умолчанию 100, максимум 500
   - **ClearNotifications**: очистка журнала уведомлений
   - **CleanupOld**: автоочистка, оставляет последние N записей
   - **Вспомогательные методы создания уведомлений**:
     * CreateOpenNotification, CreateCloseNotification
     * CreateSLNotification, CreateLiquidationNotification
     * CreateErrorNotification, CreateMarginNotification
     * CreatePauseNotification, CreateSecondLegFailNotification

2. **NotificationHandler** (`internal/api/handlers/notification_handler.go`)
   - **GET /api/v1/notifications**: получение списка уведомлений
     * Query параметры: types (через запятую), limit
     * Возвращает массив уведомлений с total count
     * HTTP коды: 200 OK, 500 Internal Server Error
   - **DELETE /api/v1/notifications**: очистка журнала
     * HTTP коды: 200 OK, 500 Internal Server Error

3. **Обновление routes.go**:
   - Добавлен NotificationService в Dependencies
   - NotificationHandler получает NotificationService через конструктор
   - Условная регистрация routes (проверка nil)

4. **Обновление main.go**:
   - Инициализация NotificationRepository
   - Создание NotificationService с передачей репозиториев
   - Передача NotificationService в Dependencies

---

### 2025-12-01: REST API endpoints для Settings (Приоритет 6.2)

**Реализовано:**

1. **SettingsService** (`internal/service/settings_service.go`)
   - **GetSettings**: получение глобальных настроек
   - **UpdateSettings**: обновление настроек с валидацией
     * Поддержка частичного обновления (только переданные поля)
     * Валидация max_concurrent_trades >= 1 или null
     * Поддержка partial update для notification_prefs
   - **UpdateNotificationPrefs**: обновление только настроек уведомлений
   - **UpdateMaxConcurrentTrades**: обновление лимита одновременных арбитражей
   - **UpdateConsiderFunding**: обновление настройки учета фандинга
   - **GetNotificationPrefs**: получение настроек уведомлений
   - **GetMaxConcurrentTrades**: получение лимита арбитражей
   - **ResetToDefaults**: сброс к дефолтным значениям

2. **SettingsHandler** (`internal/api/handlers/settings_handler.go`)
   - **GET /api/v1/settings**: получение глобальных настроек
     * HTTP коды: 200 OK, 500 Internal Server Error
   - **PATCH /api/v1/settings**: обновление настроек
     * Поддержка частичного обновления
     * clear_max_concurrent_trades для явного сброса в null
     * Валидация с понятными сообщениями об ошибках
     * HTTP коды: 200 OK, 400 Bad Request, 500 Internal Server Error

3. **Обновление routes.go**:
   - Добавлен SettingsService в Dependencies
   - SettingsHandler получает SettingsService через конструктор
   - Условная регистрация routes (проверка nil)

4. **Обновление main.go**:
   - Инициализация SettingsRepository
   - Создание SettingsService с передачей репозитория
   - Передача SettingsService в Dependencies

---

### 2025-12-01: REST API endpoints для Stats (Приоритет 6.2)

**Реализовано:**

1. **StatsService** (`internal/service/stats_service.go`)
   - **GetStats**: полная агрегированная статистика
     * Количество сделок (сегодня/неделя/месяц/всего)
     * PNL (сегодня/неделя/месяц/всего)
     * Статистика Stop Loss с деталями событий
     * Статистика ликвидаций с деталями событий
     * Топ-5 пар по сделкам/прибыли/убыткам
   - **GetTopPairs**: топ пар по метрикам (trades/profit/loss)
   - **ResetStats**: сброс всех счетчиков (удаление из trades)
   - **RecordTradeCompletion**: запись завершенной сделки
   - **GetTradesByPair**: история сделок по паре
   - **CleanupOldTrades**: автоматическая очистка старых данных

2. **StatsHandler** (`internal/api/handlers/stats_handler.go`)
   - **GET /api/v1/stats**: агрегированная статистика
     * Пустые массивы возвращаются как [], не null
     * HTTP коды: 200 OK, 500 Internal Server Error
   - **GET /api/v1/stats/top-pairs**: топ-5 пар по метрике
     * Query параметры: metric (trades/profit/loss), limit (1-20)
     * Валидация метрики с понятным сообщением об ошибке
     * HTTP коды: 200 OK, 400 Bad Request, 500 Internal Server Error
   - **POST /api/v1/stats/reset**: сброс счетчиков
     * HTTP коды: 200 OK, 500 Internal Server Error

3. **Обновление routes.go**:
   - Добавлен StatsService в Dependencies
   - StatsHandler получает StatsService через конструктор
   - Условная регистрация routes (проверка nil)

4. **Обновление main.go**:
   - Инициализация StatsRepository
   - Создание StatsService с передачей репозиториев
   - Передача StatsService в Dependencies

---

### 2025-12-01: REST API endpoints для Exchanges (Приоритет 6.2)

**Реализовано:**

1. **ExchangeHandler** (`internal/api/handlers/exchange_handler.go`)
   - **POST /api/v1/exchanges/{name}/connect**:
     * Валидация входных данных (api_key, secret_key, passphrase)
     * Проверка поддержки биржи (bybit, bitget, okx, gate, htx, bingx)
     * Обязательный passphrase для OKX
     * Интеграция с ExchangeService.ConnectExchange
     * HTTP коды: 200 OK, 400 Bad Request, 401 Unauthorized, 409 Conflict
   - **DELETE /api/v1/exchanges/{name}/connect**:
     * Отключение биржи через ExchangeService.DisconnectExchange
     * HTTP коды: 200 OK, 404 Not Found, 409 Conflict
   - **GET /api/v1/exchanges**:
     * Получение списка всех бирж с их статусами
     * API ключи не возвращаются (безопасность)
   - **GET /api/v1/exchanges/{name}/balance**:
     * Обновление и получение баланса биржи
     * Запрос к API биржи в реальном времени

2. **Обновление routes.go**:
   - Добавлена структура Dependencies для внедрения зависимостей
   - ExchangeHandler получает ExchangeService через конструктор

3. **Обновление main.go**:
   - Инициализация подключения к PostgreSQL
   - Создание репозиториев (ExchangeRepository, PairRepository)
   - Создание ExchangeService с передачей ключа шифрования
   - Передача Dependencies в SetupRoutes
   - Graceful shutdown с закрытием соединений бирж

---

### 2025-12-01: Реализация ExchangeService (Приоритет 5.2)

**Реализовано:**

1. **AES-256-GCM шифрование** (`pkg/crypto/encrypt.go`)
   - Encrypt/Decrypt функции с base64 кодированием
   - GenerateKey для генерации криптографически стойких ключей
   - Валидация длины ключа (32 байта для AES-256)
   - EncryptWithKeyString/DecryptWithKeyString для удобства

2. **ExchangeService** (`internal/service/exchange_service.go`)
   - **ConnectExchange**:
     * Проверка поддержки биржи
     * Тестовое подключение к API (валидация ключей)
     * Получение баланса для проверки работоспособности
     * Шифрование API ключей перед сохранением в БД
     * Кэширование активных соединений
   - **DisconnectExchange**:
     * Проверка наличия подключения
     * Остановка всех активных пар (если останется < 2 бирж)
     * Очистка ключей из БД
     * Закрытие соединений
   - **UpdateBalance**: запрос баланса через API, обновление в БД
   - **GetAllExchanges**: список всех бирж без API ключей
   - **GetConnection**: получение активного соединения для торгового движка
   - **UpdateAllBalances**: массовое обновление балансов
   - **HasMinimumExchanges**: проверка минимума для арбитража (≥2)

---

### 2025-12-01: Реализация методов репозиториев (Приоритет 4.2)

**Реализовано для всех 7 репозиториев:**

1. **ExchangeRepository** (`internal/repository/exchange_repository.go`)
   - Create, GetByID, GetByName, GetAll, GetConnected
   - Update, Delete, DeleteByName
   - UpdateBalance, UpdateBalanceByName, SetConnected, SetLastError
   - CountConnected
   - Обработка sql.ErrNoRows → ErrExchangeNotFound
   - Обработка unique violation → ErrExchangeExists

2. **PairRepository** (`internal/repository/pair_repository.go`)
   - Create, GetByID, GetBySymbol, GetAll, GetActive, GetPaused
   - Update, UpdateParams, Delete
   - UpdateStatus, IncrementTrades, UpdatePnl, ResetStats
   - Count, CountActive, ExistsBySymbol, Search

3. **OrderRepository** (`internal/repository/order_repository.go`)
   - Create, GetByID, GetByPairID, GetRecent
   - GetByStatus, GetByExchange
   - UpdateStatus, SetError, Delete, DeleteByPairID
   - DeleteOlderThan, Count, CountByStatus
   - GetFilledByPairIDInTimeRange

4. **NotificationRepository** (`internal/repository/notification_repository.go`)
   - Create, GetByID, GetRecent, GetByTypes
   - GetByPairID, GetBySeverity, GetInTimeRange
   - DeleteAll, DeleteOlderThan, DeleteByPairID
   - Count, CountByType, CountBySeverity, KeepRecent
   - JSON сериализация/десериализация поля meta

5. **SettingsRepository** (`internal/repository/settings_repository.go`)
   - Get (с автосозданием дефолтной записи)
   - Update, UpdateNotificationPrefs
   - UpdateConsiderFunding, UpdateMaxConcurrentTrades
   - GetNotificationPrefs, GetMaxConcurrentTrades
   - ResetToDefaults
   - JSON сериализация NotificationPreferences

6. **BlacklistRepository** (`internal/repository/blacklist_repository.go`)
   - Create, GetAll, GetByID, GetBySymbol
   - Delete, DeleteByID, Exists
   - UpdateReason, Count, DeleteAll, Search
   - Автоматическое приведение символов к верхнему регистру

7. **StatsRepository** (`internal/repository/stats_repository.go`)
   - RecordTrade с поддержкой was_stop_loss и was_liquidation
   - GetStats (агрегация по день/неделя/месяц)
   - GetTopPairsByTrades, GetTopPairsByProfit, GetTopPairsByLoss
   - ResetCounters, DeleteOlderThan
   - GetTradesByPairID, GetTradesInTimeRange
   - Count, GetPNLBySymbol

**Исправлено:**

8. **Position Manager StopLoss** (`internal/bot/position.go:176-180`)
   - Было: ps.Config.StopLossPct (несуществующее поле)
   - Стало: ps.Config.StopLoss (абсолютное значение в USDT)

---

### 2025-12-01: Реализация коннекторов бирж (Приоритет 3.3)

**Реализовано для всех 6 бирж (Bybit, Bitget, OKX, Gate.io, HTX, BingX):**

1. **REST API клиенты:**
   - HMAC-SHA256/SHA512 подписи запросов
   - Получение баланса (equity в USDT)
   - Получение тикеров (bid/ask/last price)
   - Получение стакана ордеров
   - Размещение рыночных ордеров
   - Получение открытых позиций
   - Закрытие позиций
   - Получение комиссий тейкера
   - Получение лимитов инструментов

2. **WebSocket клиенты:**
   - Публичные подписки на тикеры
   - Приватные подписки на позиции (где поддерживается)
   - Автоматическая аутентификация
   - Потокобезопасная обработка callbacks

3. **Конвертация символов:**
   - Bybit: BTCUSDT (прямой формат)
   - Bitget: BTCUSDT (прямой формат)
   - OKX: BTC-USDT-SWAP
   - Gate.io: BTC_USDT
   - HTX: BTC-USDT
   - BingX: BTC-USDT

---

### 2024-XX-XX: Оптимизация bottlenecks торгового ядра

**Реализовано:**

1. **Rate Limiter** (`pkg/ratelimit/limiter.go`)
   - Token Bucket алгоритм с поддержкой burst
   - Методы: Wait (блокирующий), Allow (неблокирующий), Reserve
   - MultiLimiter для разных категорий запросов
   - Потокобезопасная реализация

2. **Retry Logic** (`pkg/retry/retry.go`)
   - Exponential backoff с jitter
   - Конфигурации: Default, Aggressive, Conservative, Network
   - Generic DoWithResult для операций с результатом
   - Wrapper'ы: Permanent (не retry), Temporary (retry)

3. **Position Manager** (`internal/bot/position.go`)
   - Мониторинг открытых позиций
   - Расчет PNL по каждой ноге
   - Проверка условий выхода (exit spread)
   - Проверка Stop Loss
   - Обработка ликвидаций

**Исправлено:**

4. **WebSocket race condition** (`internal/websocket/client.go:130-150`)
   - Было: `n := len(c.send); for i < n { <-c.send }`
   - Стало: non-blocking select в цикле drainLoop

5. **maxMessageSize** (`internal/websocket/client.go:22`)
   - Было: 512 байт (слишком мало для JSON)
   - Стало: 65536 байт (64KB)

6. **broadcastPairStates RLock** (`internal/bot/engine.go:427-458`)
   - Было: RLock на весь цикл broadcast (300-900ms)
   - Стало: RLock только на копирование (~1ms)

---

### 2025-12-01: Реализация PairService (Приоритет 5.2)

**Реализовано:**

1. **PairService** (`internal/service/pair_service.go`)
   - **CreatePair**:
     * Валидация параметров (спреды > 0, объем > 0, n_orders ≥ 1)
     * Проверка лимита количества пар (max 30)
     * Проверка доступности символа на ≥2 биржах через GetTicker
     * Нормализация символа (uppercase)
     * Сохранение в БД и добавление в движок
   - **UpdatePair**:
     * Валидация новых параметров
     * Проверка наличия открытой позиции
     * Отложенное применение (PendingConfig) при открытой позиции
     * Немедленное применение при отсутствии позиции
   - **DeletePair**:
     * Проверка, что пара на паузе
     * Проверка отсутствия открытых позиций
     * Удаление из движка и БД
   - **StartPair**:
     * Проверка подключения ≥2 бирж
     * Проверка доступности символа
     * Запуск мониторинга в движке
   - **PausePair**:
     * Опциональное принудительное закрытие (forceClose=true)
     * Остановка в движке и обновление статуса
   - **Вспомогательные методы**:
     * GetPairWithRuntime - объединение конфига и runtime
     * ApplyPendingConfig - применение отложенных изменений
     * GetSymbolAvailability - список бирж для символа
     * RecordTradeCompletion - запись завершения сделки

2. **Интеграция с Engine** (`internal/bot/engine.go`)
   - **GetPairRuntime**: получение runtime состояния пары
   - **ForceClosePair**: принудительное закрытие позиций
   - **UpdatePairConfig**: обновление конфигурации в движке
   - **HasOpenPosition**: проверка наличия открытой позиции

3. **OrderExecutor** (`internal/bot/order.go`)
   - Добавлена структура CloseParams
   - Добавлено поле TotalPnl в ExecuteResult
   - CloseParallel рассчитывает PNL при закрытии

**Ошибки PairService:**
- ErrInvalidEntrySpread - спред входа должен быть > 0
- ErrInvalidExitSpread - спред выхода должен быть < спреда входа
- ErrInvalidVolume - объем должен быть > 0
- ErrInvalidNOrders - количество ордеров должно быть ≥ 1
- ErrSymbolNotAvailable - символ должен быть доступен на ≥2 биржах
- ErrNotEnoughExchanges - для арбитража нужно ≥2 подключенных бирж
- ErrPairHasOpenPosition - нельзя удалить/остановить пару с открытой позицией
- ErrMaxPairsReached - достигнут лимит 30 пар

---

### 2025-12-XX: Реализация Frontend (Приоритет 9)

**Реализовано:**

1. **Базовая структура проекта** (`frontend/`)
   - Инициализация проекта на Vite + React + TypeScript
   - Настройка package.json с зависимостями (React, TypeScript, Axios, React Query, Zustand, Tailwind CSS)
   - Настройка tsconfig.json
   - Полная типизация TypeScript интерфейсов (`frontend/src/types/index.ts`)

2. **Сервисы** (`frontend/src/services/`)
   - **API клиент** (`api.ts`): Axios HTTP клиент с interceptors для авторизации и обработки ошибок
     * Полная реализация всех endpoints: exchanges, pairs, notifications, stats, blacklist, settings
     * Типизированные методы для всех операций
   - **WebSocket клиент** (`websocket.ts`): Singleton сервис для WebSocket соединения
     * Автоматическое переподключение с exponential backoff
     * Подписки на типы сообщений: pairUpdate, notification, balanceUpdate, statsUpdate
     * Ping/Pong для поддержания соединения
     * Обработка ошибок и переподключений

3. **Хуки** (`frontend/src/hooks/`)
   - **usePairs**: Работа с торговыми парами
     * Интеграция с WebSocket для real-time обновлений (pairUpdate)
     * CRUD операции через React Query
     * Подсчет активных пар и пар с открытыми позициями
   - **useExchanges**: Работа с биржами
     * Интеграция с WebSocket для real-time обновлений балансов (balanceUpdate)
     * Подключение/отключение бирж
     * Обновление балансов
   - **useWebSocket**: Управление WebSocket соединением
     * Статус соединения (connecting, connected, disconnected, error)
     * Автоматическое подключение при монтировании
     * Специализированные хуки: usePairUpdates, useBalanceUpdates, useNotificationUpdates, useStatsUpdates
   - **useNotifications**: Работа с уведомлениями
     * Интеграция с WebSocket для real-time уведомлений
     * Фильтрация по типам уведомлений
     * Автоматическое добавление новых уведомлений в начало списка

4. **Общие компоненты** (`frontend/src/components/Common/`)
   - **Header**: Шапка приложения с индикатором статуса WebSocket соединения
     * Визуальная индикация статуса (зеленый/желтый/красный/серый)
     * Отображение текущего времени
   - **Navigation**: Навигация по вкладкам (БОТ, API/STATS, Уведомления)
   - **BalanceBar**: Панель с балансами бирж
     * Real-time обновления через WebSocket
     * Отображение общего баланса
     * Кнопка ручного обновления

5. **Вкладка БОТ** (`frontend/src/pages/BotPage.tsx`, `frontend/src/components/Bot/`)
   - **BotPage**: Главная страница бота
     * Отображение балансов и статистики пар
     * Сетка карточек пар (адаптивная: 1/2/3 колонки)
     * Кнопка добавления пары (с проверкой лимита 30 пар)
   - **PairCard**: Карточка торговой пары
     * Цветовая индикация статуса (зеленый/оранжевый/белый)
     * Отображение параметров (Р.О, С.В, С.ВЫ, N.ОР, SL)
     * Real-time отображение позиций (биржа, side, цена, PNL) через WebSocket
     * Суммарный PNL по связке
     * Кнопки управления: Старт/Пауза, Изменить, Удалить
     * Обновление данных каждую секунду через WebSocket
   - **AddPairModal**: Модальное окно добавления пары
   - **EditPairModal**: Модальное окно редактирования пары
   - **Blacklist**: Компонент черного списка пар

6. **Вкладка API/STATS** (`frontend/src/pages/APIStatsPage.tsx`, `frontend/src/components/API/`, `frontend/src/components/Stats/`)
   - **APIStatsPage**: Страница API и статистики
   - **ExchangeList**: Список всех поддерживаемых бирж
   - **ExchangeCard**: Карточка биржи
     * Логотип биржи
     * Статус подключения (зеленый/красный)
     * Поля для API Key и Secret (с маскированием)
     * Кнопки: Подключить/Изменить/Отключить
     * Отображение баланса (equity) с real-time обновлениями
   - **StatsOverview**: Обзор статистики
     * Количество сделок (день/неделя/месяц)
     * Общий PNL (день/неделя/месяц) с цветовой индикацией
     * Счетчик SL (с деталями)
     * Счетчик ликвидаций (с деталями)
     * Кнопка сброса счетчиков
     * **Интеграция WebSocket для real-time обновлений** (statsUpdate)
     * Индикатор "Live" при активных WebSocket обновлениях
   - **TopPairs**: Топ-5 пар по метрикам (сделки/прибыль/убытки)
   - **EventsList**: Список событий SL и ликвидаций

7. **Вкладка Уведомления** (`frontend/src/pages/NotificationsPage.tsx`, `frontend/src/components/Notifications/`)
   - **NotificationsPage**: Страница уведомлений
   - **NotificationFeed**: Лента уведомлений
     * Real-time добавление новых уведомлений через WebSocket
     * Цветовая индикация по типам (зеленый/желтый/красный)
     * Иконки для каждого типа уведомления
     * Временные отметки
   - **NotificationFilters**: Фильтры по типам уведомлений
     * Чекбоксы для каждого типа
     * Кнопки "Включить все" / "Отключить все"
     * Фильтрация в реальном времени

8. **Главное приложение** (`frontend/src/App.tsx`, `frontend/src/index.tsx`)
   - **App**: Главный компонент с роутингом
     * React Router для навигации
     * React Query Provider для управления состоянием
     * WebSocket Provider для инициализации соединения
   - **index.tsx**: Точка входа приложения

**Особенности реализации:**

- **Real-time обновления через WebSocket:**
  * Параметры пар (цены, PNL, спред) обновляются каждую секунду
  * Балансы бирж обновляются каждую минуту
  * Статистика обновляется при каждом событии
  * Уведомления добавляются мгновенно при появлении

- **Адаптивный дизайн:**
  * Tailwind CSS для стилизации
  * Адаптивная сетка карточек (1/2/3 колонки в зависимости от размера экрана)
  * Оптимизация для мобильных устройств

- **UX улучшения:**
  * Индикатор статуса WebSocket соединения в Header
  * Индикатор "Live" в StatsOverview при активных обновлениях
  * Loading states для всех асинхронных операций
  * Обработка ошибок с понятными сообщениями
  * Fallback на polling при недоступности WebSocket

- **Производительность:**
  * React Query для кэширования и оптимистичных обновлений
  * Мемоизация компонентов через useCallback и useMemo
  * Оптимизация перерисовок через правильное использование хуков
