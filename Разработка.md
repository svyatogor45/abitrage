# План разработки арбитражного веб-терминала

## Обзор

Данный документ содержит пошаговый план разработки проекта, разбитый по приоритетам. План основан на документах **Архитектура.md** и **Тз.md**.

### Условные обозначения

| Символ | Значение |
|--------|----------|
| `[ ]` | Не начато |
| `[~]` | В процессе |
| `[x]` | Завершено |
| `[!]` | Заблокировано |

---

## Приоритет 1: Базовая инфраструктура (КРИТИЧЕСКИЙ)

> **Цель:** Создать фундамент проекта — конфигурация, БД, базовые модели и HTTP сервер.

### 1.1 Конфигурация и запуск

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Структура конфигурации | `internal/config/config.go` | Загрузка переменных окружения, валидация, значения по умолчанию |
| `[x]` | Пример .env файла | `.env.example` | Шаблон переменных окружения |
| `[x]` | Go модули | `go.mod` | Зависимости проекта |
| `[x]` | Генерация go.sum | `go.sum` | Выполнить `go mod tidy` |

### 1.2 База данных и миграции

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Таблица exchanges | `migrations/001_*.sql` | Хранение API ключей бирж |
| `[x]` | Таблица pairs | `migrations/002_*.sql` | Конфигурация торговых пар |
| `[x]` | Таблица orders | `migrations/003_*.sql` | История ордеров |
| `[x]` | Таблица notifications | `migrations/004_*.sql` | Журнал уведомлений |
| `[x]` | Таблица settings | `migrations/005_*.sql` | Глобальные настройки |
| `[x]` | Таблица blacklist | `migrations/006_*.sql` | Черный список пар |
| `[x]` | Таблица trades | `migrations/007_*.sql` | Завершенные арбитражи (статистика) |

### 1.3 Модели данных

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeAccount | `internal/models/exchange_account.go` | Модель биржевого аккаунта |
| `[x]` | PairConfig | `internal/models/pair.go` | Конфигурация торговой пары |
| `[x]` | PairRuntime | `internal/models/pair_runtime.go` | Runtime состояние пары (Leg) |
| `[x]` | OrderRecord | `internal/models/order.go` | Запись об ордере |
| `[x]` | Notification | `internal/models/notification.go` | Уведомление о событии |
| `[x]` | Settings | `internal/models/settings.go` | Глобальные настройки |
| `[x]` | BlacklistEntry | `internal/models/blacklist.go` | Запись черного списка |
| `[x]` | Stats | `internal/models/stats.go` | Агрегированная статистика |

### 1.4 Точка входа и HTTP сервер

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Main функция | `cmd/server/main.go` | Инициализация, graceful shutdown |
| `[x]` | Маршрутизация | `internal/api/routes.go` | Регистрация всех HTTP маршрутов |
| `[x]` | CORS middleware | `internal/api/middleware/cors.go` | Настройка CORS заголовков |
| `[x]` | Logging middleware | `internal/api/middleware/logging.go` | Логирование HTTP запросов |
| `[x]` | Recovery middleware | `internal/api/middleware/recovery.go` | Восстановление после паники |
| `[x]` | Auth middleware | `internal/api/middleware/auth.go` | JWT аутентификация |

### 1.5 Docker и деплой

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Dockerfile | `Dockerfile` | Сборка Go приложения |
| `[x]` | Docker Compose | `docker-compose.yml` | Оркестрация сервисов |

---

## Приоритет 2: Утилиты и вспомогательные пакеты (ВЫСОКИЙ)

> **Цель:** Реализовать переиспользуемые библиотеки для шифрования, логирования, retry логики.

### 2.1 Криптография

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | AES-256 шифрование | `pkg/crypto/encrypt.go` | Encrypt/Decrypt для API ключей |
| `[x]` | Bcrypt хеширование | `pkg/crypto/hash.go` | Хеширование паролей |

### 2.2 Утилиты

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Математические функции | `pkg/utils/math.go` | RoundToLotSize, CalculateSpread, CalculateNetSpread |
| `[x]` | Логирование | `pkg/utils/logger.go` | Структурированное логирование (zap/logrus) |
| `[x]` | Работа со временем | `pkg/utils/time.go` | GetDayStart, GetWeekStart, GetMonthStart |
| `[x]` | Валидация | `pkg/utils/validator.go` | ValidateSymbol, ValidateSpread, ValidateVolume |

### 2.3 Retry и Rate Limiting

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Retry механизм | `pkg/retry/retry.go` | Экспоненциальный backoff (2s, 4s, 8s, 16s) |
| `[x]` | Rate limiter | `pkg/ratelimit/limiter.go` | Token Bucket для контроля частоты запросов |

---

## Приоритет 3: Интеграция с биржами (ВЫСОКИЙ)

> **Цель:** Реализовать унифицированный интерфейс для работы с биржами и коннекторы к каждой бирже.

### 3.1 Общий интерфейс

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Exchange interface | `internal/exchange/interface.go` | Унифицированный интерфейс (Connect, GetBalance, PlaceMarketOrder, etc.) |
| `[x]` | Exchange factory | `internal/exchange/factory.go` | NewExchange(name) - создание экземпляра биржи |

### 3.2 Реализации для бирж

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Bybit коннектор | `internal/exchange/bybit.go` | Bybit API v5, WebSocket |
| `[x]` | Bitget коннектор | `internal/exchange/bitget.go` | Bitget Futures API |
| `[x]` | OKX коннектор | `internal/exchange/okx.go` | OKX Futures API (+ passphrase) |
| `[x]` | Gate.io коннектор | `internal/exchange/gate.go` | Gate.io Futures API |
| `[x]` | HTX коннектор | `internal/exchange/htx.go` | HTX Linear Swaps API |
| `[x]` | BingX коннектор | `internal/exchange/bingx.go` | BingX Perpetual Futures API |

### 3.3 Функциональность каждого коннектора

Для каждой биржи (Bybit, Bitget, OKX, Gate.io, HTX, BingX) реализовано:

- [x] `Connect(apiKey, secret string) error` - подключение и проверка ключей
- [x] `GetBalance() (float64, error)` - получение equity в USDT
- [x] `GetTicker(symbol string) (Ticker, error)` - текущая цена
- [x] `GetOrderBook(symbol string, depth int) (OrderBook, error)` - стакан ордеров
- [x] `PlaceMarketOrder(symbol, side string, qty float64) (Order, error)` - рыночный ордер
- [x] `GetOpenPositions() ([]Position, error)` - открытые позиции
- [x] `ClosePosition(symbol, side string, qty float64) error` - закрытие позиции
- [x] `SubscribeTicker(symbol string, callback func(Ticker))` - WebSocket подписка
- [x] `GetTradingFee(symbol string) (float64, error)` - комиссия тейкера
- [x] `GetLimits(symbol string) (Limits, error)` - лимиты биржи (min/max)

---

## Приоритет 4: Репозитории (Data Access Layer) (ВЫСОКИЙ)

> **Цель:** Реализовать слой доступа к данным для всех сущностей.

### 4.1 CRUD репозитории

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeRepository | `internal/repository/exchange_repository.go` | CRUD для бирж, UpdateBalance |
| `[x]` | PairRepository | `internal/repository/pair_repository.go` | CRUD для пар, GetActive, UpdateStatus |
| `[x]` | OrderRepository | `internal/repository/order_repository.go` | CRUD для ордеров, GetByPairID |
| `[x]` | NotificationRepository | `internal/repository/notification_repository.go` | CRUD, GetByTypes, DeleteOlderThan |
| `[x]` | SettingsRepository | `internal/repository/settings_repository.go` | Get/Update настроек |
| `[x]` | BlacklistRepository | `internal/repository/blacklist_repository.go` | CRUD, Exists |
| `[x]` | StatsRepository | `internal/repository/stats_repository.go` | GetStats, RecordTrade, RecordStopLoss, RecordLiquidation |

### 4.2 Реализация методов репозиториев

Для каждого репозитория:
- [x] Реализовать SQL запросы
- [x] Обработка ошибок (sql.ErrNoRows, etc.)
- [x] Транзакционная поддержка где необходимо
- [x] Тесты (sqlmock, покрытие 73.9%)

---

## Приоритет 5: Сервисный слой (Бизнес-логика) (ВЫСОКИЙ)

> **Цель:** Реализовать бизнес-логику между API и репозиториями.

### 5.1 Сервисы

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeService | `internal/service/exchange_service.go` | ConnectExchange, DisconnectExchange, UpdateBalance |
| `[x]` | PairService | `internal/service/pair_service.go` | CreatePair, UpdatePair, StartPair, PausePair |
| `[x]` | StatsService | `internal/service/stats_service.go` | GetStats, GetTopPairs, ResetStats, RecordTradeCompletion (полностью реализовано) |
| `[x]` | NotificationService | `internal/service/notification_service.go` | CreateNotification, GetNotifications, ClearNotifications |
| `[x]` | RiskService | `internal/service/risk_service.go` | CheckStopLoss, CheckMarginRequirement, HandleLiquidation |

### 5.2 Ключевая логика сервисов

**ExchangeService:**
- [x] Шифрование API ключей перед сохранением
- [x] Тестовое подключение при ConnectExchange
- [x] Остановка пар при DisconnectExchange

**PairService:**
- [x] Валидация параметров (спреды > 0, объем > 0)
- [x] Проверка доступности актива на ≥2 биржах
- [x] Отложенное применение изменений при открытой позиции
- [x] Принудительное закрытие при PausePair с forceClose=true

**NotificationService:**
- [x] Проверка настроек уведомлений перед созданием
- [x] Broadcast через WebSocket Hub

---

## Приоритет 6: REST API Handlers (ВЫСОКИЙ)

> **Цель:** Реализовать HTTP обработчики для всех endpoints.

### 6.1 Handlers

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeHandler | `internal/api/handlers/exchange_handler.go` | POST/DELETE /exchanges/{name}/connect, GET /exchanges |
| `[x]` | PairHandler | `internal/api/handlers/pair_handler.go` | CRUD /pairs, /pairs/{id}/start, /pairs/{id}/pause (полностью реализовано) |
| `[x]` | NotificationHandler | `internal/api/handlers/notification_handler.go` | GET/DELETE /notifications |
| `[x]` | StatsHandler | `internal/api/handlers/stats_handler.go` | GET /stats, POST /stats/reset |
| `[x]` | BlacklistHandler | `internal/api/handlers/blacklist_handler.go` | CRUD /blacklist (полностью реализовано) |
| `[x]` | SettingsHandler | `internal/api/handlers/settings_handler.go` | GET/PATCH /settings |

### 6.2 Реализация endpoints

**Exchanges:**
- [x] `POST /api/exchanges/{name}/connect` - подключение биржи
- [x] `DELETE /api/exchanges/{name}/connect` - отключение биржи
- [x] `GET /api/exchanges` - список бирж и статусов
- [x] `GET /api/exchanges/{name}/balance` - обновление баланса

**Pairs:**
- [x] `POST /api/pairs` - добавление пары
- [x] `GET /api/pairs` - список всех пар
- [x] `GET /api/pairs/{id}` - конкретная пара
- [x] `PATCH /api/pairs/{id}` - редактирование пары
- [x] `DELETE /api/pairs/{id}` - удаление пары
- [x] `POST /api/pairs/{id}/start` - запуск мониторинга
- [x] `POST /api/pairs/{id}/pause` - приостановка

**Notifications:**
- [x] `GET /api/notifications` - список уведомлений
- [x] `GET /api/notifications?types=open,close,error` - с фильтрацией
- [x] `DELETE /api/notifications` - очистка журнала

**Stats:**
- [x] `GET /api/stats` - агрегированная статистика
- [x] `GET /api/stats/top-pairs` - топ-5 пар
- [x] `POST /api/stats/reset` - сброс счетчиков

**Blacklist:**
- [x] `GET /api/blacklist` - черный список
- [x] `POST /api/blacklist` - добавление в ЧС
- [x] `DELETE /api/blacklist/{symbol}` - удаление из ЧС

**Settings:**
- [x] `GET /api/settings` - глобальные настройки
- [x] `PATCH /api/settings` - обновление настроек

---

## Приоритет 7: WebSocket (ВЫСОКИЙ)

> **Цель:** Реализовать real-time коммуникацию между сервером и клиентами.

### 7.1 WebSocket инфраструктура

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | WebSocket Hub | `internal/websocket/hub.go` | Центральный менеджер соединений, broadcast |
| `[x]` | WebSocket Client | `internal/websocket/client.go` | Управление индивидуальным соединением |

### 7.2 Типы сообщений

| Статус | Сообщение | Описание | Файл |
|--------|-----------|----------|------|
| `[x]` | `pairUpdate` | Обновление состояния пары (цены, PNL, спред) - каждую секунду | `internal/websocket/messages.go` |
| `[x]` | `notification` | Новое уведомление (OPEN, CLOSE, SL, LIQUIDATION, ERROR, etc.) | `internal/websocket/messages.go` |
| `[x]` | `balanceUpdate` | Обновление баланса биржи - каждую минуту | `internal/websocket/messages.go` |
| `[x]` | `statsUpdate` | Обновление статистики | `internal/websocket/messages.go` |

**Интеграция в сервисы:**
- [x] `NotificationService.SetWebSocketHub()` - broadcast уведомлений
- [x] `ExchangeService.SetWebSocketHub()` - broadcast балансов
- [x] `StatsService.SetWebSocketHub()` - broadcast статистики
- [x] `Engine.BroadcastPairUpdate()` - broadcast состояния пар

### 7.3 Функциональность

- [x] Регистрация/отмена регистрации клиентов
- [x] Ping/Pong для проверки живости соединения
- [x] Буферизация исходящих сообщений (оптимизировано: исправлен race condition)
- [x] Graceful закрытие соединений
- [x] Обработка переподключений (WSReconnectManager с exponential backoff)

> **Оптимизации:**
> - maxMessageSize увеличен с 512 до 65536 байт
> - Исправлен race condition в writePump при чтении из буфера
> - Увеличены ReadBufferSize/WriteBufferSize до 4096 байт

---

## Приоритет 8: Торговый движок (Бот) (КРИТИЧЕСКИЙ)

> **Цель:** Реализовать основную торговую логику арбитражного бота.

### 8.1 Core компоненты бота

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Engine | `internal/bot/engine.go` | Главный event loop, координация |
| `[x]` | State Machine | `internal/bot/state_machine.go` | Состояния пары (PAUSED, READY, ENTERING, HOLDING, EXITING, ERROR) |
| `[x]` | Arbitrage | `internal/bot/arbitrage.go` | Логика принятия решений об арбитраже |
| `[x]` | Spread Calculator | `internal/bot/spread.go` | Расчет спреда с учетом комиссий |
| `[x]` | Order Executor | `internal/bot/order.go` | Исполнение ордеров на биржах |
| `[x]` | Position Manager | `internal/bot/position.go` | Сопровождение открытых позиций |
| `[x]` | Risk Manager | `internal/bot/risk.go` | SL, ликвидации, проверка маржи |
| `[x]` | Recovery | `internal/bot/recovery.go` | Восстановление после перезапуска |

### 8.2 Engine (Главный движок)

**Функциональность:**
- [x] Главный event loop (event-driven архитектура)
- [x] Обработка всех активных пар
- [x] Координация между компонентами
- [x] Периодическое обновление балансов (каждую минуту)
- [x] Graceful shutdown
- [x] Соблюдение лимита max_concurrent_trades

> **Оптимизации:**
> - Event-driven вместо polling (мгновенная реакция на цены)
> - Шардированный worker pool для параллельной обработки
> - sync.Map для lock-free доступа к pairsBySymbol
> - Atomic counter для activeArbs (без mutex)
> - broadcastPairStates оптимизирован (короткий RLock)

### 8.3 State Machine (Машина состояний)

**Состояния:**
```
PAUSED     → пара на паузе
READY      → мониторинг активен, ожидание условий
ENTERING   → процесс входа в позицию
HOLDING    → позиция открыта, ожидание выхода
EXITING    → процесс закрытия позиции
ERROR      → ошибка, требуется вмешательство
```

**Переходы:**
- [x] PAUSED → READY (start) — через API /pairs/{id}/start
- [x] READY → ENTERING (условия входа выполнены) — в checkArbitrageOpportunity
- [x] ENTERING → HOLDING (обе ноги открыты) — в executeEntryWithConditions
- [x] ENTERING → READY (ошибка обеих ног, откат) — в executeEntryWithConditions
- [x] HOLDING → EXITING (условия выхода) — в checkExitConditionsForPair
- [x] HOLDING → PAUSED (SL или ликвидация) — в executeExit с reason=StopLoss/Liquidation
- [x] EXITING → READY (успешное закрытие) — в executeExit
- [x] Любое → ERROR (при ошибке закрытия) — в executeExit

> **Реализовано (2025-12-02):**
> - Все переходы интегрированы в engine.go и arbitrage.go
> - Атомарные флаги для быстрой проверки isReady
> - Корректные переходы после SL/ликвидации → PAUSED

### 8.4 Spread Calculator (Расчет спреда)

**Функциональность:**
- [x] Получение цен со всех подключенных бирж
- [x] Анализ стакана ордеров (5 уровней глубины)
- [x] Моделирование исполнения ордера заданного объема (VWAP, slippage)
- [x] Расчет базового спреда: `(P_high - P_low) / P_low × 100`
- [x] Учет комиссий тейкера на обеих биржах
- [x] Расчет чистого спреда (net spread)
- [x] Проверка достаточности ликвидности (CheckLiquidityForVolume)
- [x] Кэширование данных стаканов (OrderBookAnalyzer с sync.Map)

> **Реализовано в spread.go (2025-12-02):**
> - **OrderBookAnalyzer**: анализатор стаканов с кэшированием (sync.Map)
> - **SimulateBuy/SimulateSell**: моделирование исполнения рыночных ордеров
> - **AnalyzeLiquidity**: полный анализ ликвидности для арбитража
> - **GetRealSpread**: расчёт спреда с учётом VWAP и slippage
> - **GetSpreadWithLiquidity**: расширенная информация о спреде

### 8.5 Arbitrage (Логика арбитража)

**Функциональность:**
- [x] Определение арбитражных возможностей
- [x] Выбор оптимальной пары бирж (min price / max price)
- [x] Проверка условий входа: `net_spread ≥ entry_spread`
- [x] Проверка условий выхода: `spread ≤ exit_spread`
- [x] Логика частичного входа (разбиение на N ордеров)
- [x] Координация одновременного открытия/закрытия позиций
- [x] Обработка кейса "вторая нога не открылась"

> **Реализовано в arbitrage.go (2025-12-02):**
> - **ArbitrageDetector**: детектор арбитражных возможностей (O(1) через PriceTracker)
> - **DetectOpportunity / DetectWithLiquidity**: обнаружение возможностей с учётом ликвидности
> - **CheckEntryConditions**: полная проверка условий входа (спред, ликвидность, маржа, лимиты)
> - **CheckExitConditions**: проверка условий выхода (спред, StopLoss, ликвидация)
> - **PartialEntryManager**: частичный вход (N ордеров) с проверкой спреда перед каждой частью
> - **SecondLegFailHandler**: обработка провала второй ноги с откатом и уведомлением
> - **ArbitrageCoordinator**: координация всех операций (TryEnter, TryExit)
> - **exitConditionChecker**: периодическая проверка выхода для HOLDING позиций
> - Интеграция с Engine: checkArbitrageOpportunity, executeEntryWithConditions, executeExit

### 8.6 Order Executor (Исполнение ордеров)

**Функциональность:**
- [x] Формирование рыночных ордеров
- [x] Одновременная отправка на две биржи (асинхронно)
- [x] Ожидание подтверждения исполнения
- [x] Получение средней цены исполнения (fill price)
- [x] Обработка частичного исполнения
- [x] Retry logic при ошибках API (до 4 попыток) - интеграция с pkg/retry
- [x] Валидация размеров ордеров (min/max limits)
- [x] Округление объемов до lot size биржи

> **Реализовано в order.go (2025-12-02):**
> - **OrderValidator**: валидатор ордеров с кэшированием лимитов
> - **ValidateOrderQty**: проверка min/max qty, округление до lot size, проверка minNotional
> - **ValidateBothLegs**: валидация обеих ног арбитража
> - **ExecuteWithValidation**: исполнение с предварительной валидацией
> - **ExecuteWithRetry**: retry с exponential backoff при сетевых ошибках
> - **PreloadLimits**: предзагрузка лимитов для всех пар

### 8.7 Position Manager (Сопровождение позиций)

**Функциональность:**
- [x] Непрерывный мониторинг открытых позиций
- [x] Получение текущих цен для расчета unrealized PNL
- [x] Расчет PNL по каждой ноге: `(P_current - P_entry) × qty`
- [x] Суммирование PNL обеих ног арбитража
- [x] Отслеживание текущего спреда между позициями
- [x] Проверка условий для закрытия позиций
- [x] Обновление данных в WebSocket (каждую секунду)

### 8.8 Risk Manager (Управление рисками)

**Функциональность:**
- [x] Мониторинг Stop Loss: `total_PNL ≤ -SL`
- [x] Автоматическое закрытие при достижении SL
- [x] Обнаружение ликвидаций через WebSocket биржи
- [x] Экстренное закрытие второй ноги при ликвидации первой
- [x] Автоматическая постановка пары на паузу после SL/ликвидации
- [x] Проверка маржинальных требований перед входом
- [x] Расчет margin requirement для позиции
- [x] Генерация уведомлений о критических событиях

> **Реализовано (2025-12-02):**
> - **CheckExitConditions**: проверка StopLoss → ExitReasonStopLoss
> - **executeExit**: пауза пары после SL/Liquidation
> - **checkMarginRequirement**: проверка маржи перед входом (кэш marginCache)
> - **notifyTradeClosed / notifyError**: уведомления через notificationChan

### 8.9 Recovery (Восстановление)

**Функциональность:**
- [x] Чтение конфигурации из БД при старте
- [x] Восстановление подключений к биржам
- [x] Обнаружение открытых позиций через API бирж
- [x] Попытка идентификации позиций бота
- [x] Восстановление runtime состояния пар
- [x] Уведомление пользователя о найденных позициях
- [x] Опциональное автоматическое закрытие "потерянных" позиций

**Реализация (2025-12-02):**

1. **RecoveryManager** (`internal/bot/recovery.go`)
   - Основной класс для восстановления работы бота после рестарта
   - `Recover(ctx)`: полный процесс восстановления
   - `RecoverAsync(ctx)`: асинхронное восстановление с каналом результата
   - `VerifyPositions(ctx)`: периодическая проверка согласованности позиций
   - `ClosePositionManually(ctx, exchange, symbol, side, qty)`: ручное закрытие позиции

2. **Шаги восстановления:**
   - Загрузка и подключение бирж из БД (параллельно)
   - Расшифровка API ключей через AES-256-GCM
   - Загрузка торговых пар из БД
   - Обнаружение открытых позиций на всех биржах (параллельно)
   - Сопоставление позиций с парами бота
   - Восстановление runtime состояния (HOLDING) для найденных пар
   - Уведомление пользователя о восстановленных и "потерянных" позициях
   - Активация мониторинга для активных пар

3. **Структуры данных:**
   - `RecoveryResult`: результаты процесса восстановления
   - `DiscoveredPosition`: найденная позиция на бирже
   - `MatchedPosition`: позиция, связанная с парой бота
   - `RecoveryConfig`: конфигурация (AutoCloseOrphaned, RecoveryTimeout)

4. **Обработка граничных случаев:**
   - Неполные позиции (одна нога) → состояние ERROR
   - "Потерянные" позиции → уведомление пользователя (опционально закрытие)
   - Ошибки подключения к биржам → уведомление, продолжение с оставшимися

---

## Приоритет 9: Frontend (React) (СРЕДНИЙ)

> **Цель:** Создать веб-интерфейс для управления ботом.

### 9.1 Базовая структура

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | Инициализация проекта | `frontend/` | Create React App или Vite с TypeScript |
| `[x]` | package.json | `frontend/package.json` | Зависимости (React, TypeScript, Axios, etc.) |
| `[x]` | tsconfig.json | `frontend/tsconfig.json` | Настройки TypeScript |
| `[x]` | Типы | `frontend/src/types/index.ts` | TypeScript интерфейсы |

### 9.2 Сервисы

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | API клиент | `frontend/src/services/api.ts` | Axios HTTP клиент |
| `[x]` | WebSocket клиент | `frontend/src/services/websocket.ts` | Подключение к WS |

### 9.3 Хуки

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | usePairs | `frontend/src/hooks/usePairs.ts` | Работа с парами |
| `[x]` | useExchanges | `frontend/src/hooks/useExchanges.ts` | Работа с биржами |
| `[x]` | useWebSocket | `frontend/src/hooks/useWebSocket.ts` | WebSocket соединение |
| `[x]` | useNotifications | `frontend/src/hooks/useNotifications.ts` | Работа с уведомлениями |

### 9.4 Общие компоненты

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | Header | `frontend/src/components/Common/Header.tsx` | Шапка приложения |
| `[x]` | Navigation | `frontend/src/components/Common/Navigation.tsx` | Навигация по вкладкам |
| `[x]` | BalanceBar | `frontend/src/components/Common/BalanceBar.tsx` | Балансы бирж |

### 9.5 Вкладка БОТ

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | BotPage | `frontend/src/pages/BotPage.tsx` | Главная страница бота |
| `[x]` | PairCard | `frontend/src/components/Bot/PairCard.tsx` | Карточка торговой пары |
| `[x]` | AddPairModal | `frontend/src/components/Bot/AddPairModal.tsx` | Модальное окно добавления |
| `[x]` | EditPairModal | `frontend/src/components/Bot/EditPairModal.tsx` | Редактирование пары |
| `[x]` | Blacklist | `frontend/src/components/Bot/Blacklist.tsx` | Черный список |

**Функциональность PairCard:**
- [x] Цветовая индикация (зеленый/оранжевый/белый)
- [x] Отображение параметров (Р.О, С.В, С.ВЫ, N.ОР, SL)
- [x] Текущие позиции (биржа, side, цена, PNL)
- [x] Суммарный PNL по связке
- [x] Кнопки: Старт/Пауза, Изменить, Удалить
- [x] Обновление данных каждую секунду (через WebSocket)

### 9.6 Вкладка API/STATS

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | APIStatsPage | `frontend/src/pages/APIStatsPage.tsx` | Страница API и статистики |
| `[x]` | ExchangeList | `frontend/src/components/API/ExchangeList.tsx` | Список бирж |
| `[x]` | ExchangeCard | `frontend/src/components/API/ExchangeCard.tsx` | Карточка биржи |
| `[x]` | StatsOverview | `frontend/src/components/Stats/StatsOverview.tsx` | Обзор статистики |
| `[x]` | TopPairs | `frontend/src/components/Stats/TopPairs.tsx` | Топ-5 пар |
| `[x]` | EventsList | `frontend/src/components/Stats/EventsList.tsx` | Список SL/ликвидаций |

**Функциональность ExchangeCard:**
- [x] Логотип биржи
- [x] Статус подключения (зеленый/красный)
- [x] Поля для API Key и Secret
- [x] Кнопки: Подключить/Изменить/Отключить
- [x] Отображение баланса (equity)

**Функциональность StatsOverview:**
- [x] Количество сделок (день/неделя/месяц)
- [x] Общий PNL (день/неделя/месяц)
- [x] Счетчик SL (с деталями)
- [x] Счетчик ликвидаций (с деталями)
- [x] Кнопки сброса счетчиков
- [x] Интеграция WebSocket для real-time обновлений

### 9.7 Вкладка Уведомления

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | NotificationsPage | `frontend/src/pages/NotificationsPage.tsx` | Страница уведомлений |
| `[x]` | NotificationFeed | `frontend/src/components/Notifications/NotificationFeed.tsx` | Лента уведомлений |
| `[x]` | NotificationFilters | `frontend/src/components/Notifications/NotificationFilters.tsx` | Фильтры по типам |

**Типы уведомлений:**
- [x] OPEN - открытие сделки (зеленый)
- [x] CLOSE - закрытие сделки (зеленый)
- [x] SL - Stop Loss (красный)
- [x] LIQUIDATION - ликвидация (красный)
- [x] ERROR - ошибка API (красный)
- [x] MARGIN - недостаток маржи (желтый)
- [x] PAUSE - пауза/остановка (желтый)
- [x] SECOND_LEG_FAIL - вторая нога не открыта (красный)
- [x] Интеграция WebSocket для real-time уведомлений

### 9.8 Главное приложение

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[x]` | App | `frontend/src/App.tsx` | Главный компонент с роутингом |
| `[x]` | index | `frontend/src/index.tsx` | Точка входа |
| `[x]` | Индикатор статуса WebSocket | `frontend/src/components/Common/Header.tsx` | Отображение статуса соединения |

---

## Приоритет 10: Тестирование (СРЕДНИЙ)

> **Цель:** Обеспечить качество кода через тестирование.

### 10.1 Unit тесты

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | Тесты моделей | Валидация структур данных |
| `[x]` | Тесты репозиториев | Mock БД, CRUD операции (sqlmock, покрытие 73.9%) |
| `[x]` | Тесты сервисов | Mock репозиториев (blacklist, settings, notification, stats, pair, exchange services) |
| `[ ]` | Тесты handlers | Mock сервисов, HTTP запросы |
| `[x]` | Тесты spread calculator | Расчет спреда с разными данными (spread_test.go: 35 тестов, покрытие 85-100%) |
| `[x]` | Тесты state machine | Переходы между состояниями (state_machine_test.go: 17 тестов + 4 бенчмарка, покрытие 100%) |
| `[x]` | Тесты crypto | Шифрование AES-256-GCM, хеширование bcrypt (encrypt_test.go, hash_test.go) |

### 10.2 Интеграционные тесты

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | API integration tests | Полный цикл запросов |
| `[ ]` | WebSocket tests | Подключение, broadcast |
| `[ ]` | Database tests | Миграции, транзакции |

### 10.3 E2E тесты (опционально)

| Статус | Задача | Описание |
|--------|--------|----------|
| `[x]` | Cypress/Playwright | Тестирование UI (Playwright e2e сценарии добавления пары и старт/пауза) |
| `[x]` | Сценарии пользователя | Добавление пары, старт/пауза |

---

## Приоритет 11: Документация и финализация (НИЗКИЙ)

> **Цель:** Документирование и подготовка к production.

### 11.1 Документация

| Статус | Задача | Описание |
|--------|--------|----------|
| `[x]` | README.md | Описание проекта, инструкции запуска |
| `[x]` | Архитектура.md | Архитектурная документация |
| `[ ]` | API документация | Swagger/OpenAPI спецификация |
| `[ ]` | Руководство пользователя | Как пользоваться терминалом |

### 11.2 Production готовность

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | SSL/TLS сертификаты | HTTPS настройка |
| `[ ]` | Nginx reverse proxy | Production конфигурация |
| `[x]` | Мониторинг и алерты | Prometheus/Grafana/Alertmanager (`monitoring/`, `docker-compose.yml`) |
| `[ ]` | Backup стратегия | Резервное копирование БД |
| `[ ]` | Rate limit tuning | Настройка лимитов для каждой биржи |

---

## Порядок выполнения (Roadmap)

### Фаза 1: Фундамент (1-2 недели)
1. ✅ Приоритет 1 (Базовая инфраструктура)
2. ✅ Приоритет 2 (Утилиты)
3. ✅ Приоритет 3.1 (Интерфейс бирж)

### Фаза 2: Backend Core (2-3 недели)
4. Приоритет 3.2 (Реализации коннекторов бирж)
5. Приоритет 4 (Репозитории - реализация SQL)
6. Приоритет 5 (Сервисный слой - реализация логики)
7. Приоритет 6 (REST API - реализация endpoints)

### Фаза 3: Торговый движок (2-3 недели)
8. Приоритет 7 (WebSocket)
9. Приоритет 8 (Торговый движок - Bot)

### Фаза 4: Frontend (2-3 недели)
10. Приоритет 9 (React приложение)

### Фаза 5: Тестирование и релиз (1-2 недели)
11. Приоритет 10 (Тестирование)
12. Приоритет 11 (Документация и production)

---

## Зависимости между компонентами

```
Config → Models → Repositories → Services → Handlers → Routes
                      ↓
                  Bot Engine
                      ↓
              Exchange Connectors
                      ↓
                WebSocket Hub → Frontend
```

---

## Критические пути

1. **Exchange Connectors** - без них невозможна торговля
2. **Bot Engine** - ядро системы
3. **WebSocket** - real-time обновления для UI
4. **State Machine** - корректные переходы между состояниями

---

## Требования к производительности торгового ядра

> **Принцип:** Торговое ядро НЕ должно быть узким местом системы. Основные задержки должны приходиться на сетевые операции биржевых API.

### Критические метрики латентности (SLA)

| Операция | Целевое время | Критическое |
|----------|---------------|-------------|
| Tick → Order (внутри кода) | < 5ms | > 50ms |
| Обработка одного PriceUpdate | < 1ms | > 10ms |
| Расчёт спреда и проверка условий | < 0.5ms | > 5ms |
| Пересчёт лучших цен (PriceTracker) | O(k), k~6 | O(n²) |

### Чеклист оптимизаций торгового ядра

#### Архитектурные требования

| Статус | Требование | Описание |
|--------|------------|----------|
| `[x]` | Event-driven (НЕ polling) | Мгновенная реакция на события WebSocket |
| `[x]` | Шардирование по символам | Разные символы не блокируют друг друга |
| `[x]` | sync.Map для hot path | Lock-free чтение в критическом пути |
| `[x]` | atomic счётчики | activeArbs и другие счётчики через atomic |
| `[x]` | Параллельная отправка ордеров | Время = max(A, B), не сумма |
| `[x]` | sync.Pool для объектов | Zero-allocation в hot path |

#### Требования к памяти и GC

| Статус | Требование | Описание |
|--------|------------|----------|
| `[x]` | Object pooling | sync.Pool для PriceUpdate, BestPrices, LegResultChan |
| `[x]` | Предаллокация слайсов | make([]T, 0, capacity) в broadcastPairStates |
| `[x]` | Буферизованные каналы | Размер 2000 на шард |
| `[x]` | Struct keys вместо строк | PriceKey, OrderBookKey, LimitsKey |

#### Требования к конкурентности

| Статус | Требование | Описание |
|--------|------------|----------|
| `[x]` | Worker pool с шардами | NumCPU шардов, 2 workers на шард |
| `[x]` | Один символ → один шард | Последовательная обработка без race conditions |
| `[x]` | RWMutex < 1ms | Копирование под Lock, обработка вне Lock |
| `[x]` | broadcastPairStates оптимизирован | Короткий RLock на копирование |

#### Требования к сетевым операциям

| Статус | Требование | Описание |
|--------|------------|----------|
| `[x]` | WebSocket для цен | Не REST polling |
| `[x]` | HTTP Keep-Alive | Connection pooling для API (`internal/exchange/httpclient.go`) |
| `[x]` | Retry с exponential backoff | 2s, 4s, 8s, 16s, не блокирует |
| `[x]` | Timeout на все операции | Connect 5s, Read/Write 10s, Total 30s (`HTTPClientConfig`) |

#### Мониторинг производительности

| Статус | Требование | Описание |
|--------|------------|----------|
| `[x]` | Метрики латентности | p50, p95, p99 для каждого этапа (`internal/bot/metrics.go`) |
| `[x]` | Счётчики событий | events/sec, overflows, retries (`internal/bot/metrics.go`) |
| `[x]` | pprof endpoints | /debug/pprof/* (`internal/api/routes.go`) |
| `[x]` | Алерты | Tick→Order > 10ms warning, > 50ms critical (`monitoring/alerts.yml`) |

### Конфигурируемые параметры

```go
type PerformanceConfig struct {
    // Worker pool
    NumShards       int           `default:"runtime.NumCPU()" min:"4" max:"32"`
    WorkersPerShard int           `default:"2" min:"1" max:"8"`
    ChannelBuffer   int           `default:"2000" min:"100" max:"10000"`

    // Timeouts
    ConnectTimeout  time.Duration `default:"5s"`
    ReadTimeout     time.Duration `default:"10s"`
    WriteTimeout    time.Duration `default:"10s"`
    TotalTimeout    time.Duration `default:"30s"`

    // Retry
    MaxRetries      int           `default:"4"`
    InitialDelay    time.Duration `default:"2s"`
    MaxDelay        time.Duration `default:"16s"`

    // Background tasks (не влияют на торговлю)
    BalanceInterval time.Duration `default:"60s" min:"30s" max:"300s"`
    StatsInterval   time.Duration `default:"60s" min:"10s" max:"300s"`
}
```

### Hot Path (критический путь)

```
WebSocket Tick → Parse → Dispatch → Shard → Spread Calc → Condition Check → Order Build → API Call
     ↓            ↓        ↓         ↓          ↓              ↓               ↓           ↓
  < 0.1ms     < 0.1ms   < 0.1ms   < 0.1ms    < 0.5ms        < 0.1ms         < 0.2ms     < 0.5ms

  ИТОГО внутри кода: < 1.5ms (резерв до 5ms)
```

**Правила для hot path:**
- ❌ Никаких блокирующих операций
- ❌ Никаких аллокаций (использовать sync.Pool)
- ❌ Никаких string concatenation
- ❌ Никаких логов уровня DEBUG (только при ошибках)
- ✅ atomic операции вместо mutex где возможно
- ✅ sync.Map для concurrent read
- ✅ Копирование под коротким Lock

### Антипаттерны (что НЕ делать)

```go
// ❌ Polling с задержкой
for {
    prices := fetchAllPrices()
    time.Sleep(100 * time.Millisecond)
}

// ❌ Длинный Lock
e.mu.Lock()
for _, pair := range e.pairs {
    // долгая обработка...
}
e.mu.Unlock()

// ❌ String concatenation в hot path
key := exchange + ":" + symbol  // аллокация!

// ❌ Последовательная отправка ордеров
result1 := sendOrder(exchange1)  // ждём
result2 := sendOrder(exchange2)  // ещё ждём
// Время = A + B
```

### Правильные паттерны

```go
// ✅ Event-driven
select {
case price := <-priceChan:
    handlePrice(price)
}

// ✅ Короткий Lock + копирование
e.mu.RLock()
pairs := make([]*PairState, len(e.pairs))
copy(pairs, e.pairs)
e.mu.RUnlock()
// обработка вне Lock

// ✅ Struct key вместо строки
type SymbolKey struct { Exchange, Symbol string }
prices[SymbolKey{exchange, symbol}] = price

// ✅ Параллельная отправка
var wg sync.WaitGroup
wg.Add(2)
go func() { defer wg.Done(); result1 = sendOrder(exchange1) }()
go func() { defer wg.Done(); result2 = sendOrder(exchange2) }()
wg.Wait()
// Время = max(A, B)
```

---

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| API биржи изменился | Средняя | Высокое | Версионирование, мониторинг изменений |
| Rate limits превышены | Высокая | Среднее | Rate limiter, кэширование |
| Потеря соединения | Высокая | Высокое | Retry logic, reconnect, graceful degradation |
| Ликвидация позиции | Низкая | Критическое | Risk manager, уведомления, автозакрытие |
| Сбой сервера | Низкая | Критическое | Recovery механизм, логирование состояний |

---

## Чеклист перед релизом

- [x] Все миграции применены
- [x] go.sum сгенерирован (`go mod tidy`)
- [ ] Все тесты проходят
- [ ] API ключи шифруются
- [ ] HTTPS настроен
- [ ] Логирование работает
- [ ] WebSocket стабилен
- [ ] Recovery протестирован
- [ ] Документация актуальна
- [ ] Docker образы собираются
- [ ] Frontend собирается для production

---

## Текущий статус проекта

**Backend (Go):**
- Структура файлов: ✅ 100% создано
- HTTP клиент: ✅ 100% реализовано (Connection Pooling, Keep-Alive, Timeouts в `internal/exchange/httpclient.go`)
- Коннекторы бирж: ✅ 100% реализовано (Bybit, Bitget, OKX, Gate.io, HTX, BingX)
- Репозитории: ✅ 100% реализовано (SQL запросы, обработка ошибок)
- ExchangeService: ✅ 100% реализовано (шифрование, подключение, отключение)
- PairService: ✅ 100% реализовано (валидация, проверка бирж, отложенные изменения, принудительное закрытие)
- NotificationService: ✅ 100% реализовано (CreateNotification, GetNotifications, ClearNotifications, проверка настроек)
- StatsService: ✅ 100% реализовано
- SettingsService: ✅ 100% реализовано
- RiskService: ✅ 100% реализовано (SL, ликвидации, проверка маржи, уведомления)
- REST API Exchanges: ✅ 100% реализовано (4/4 endpoints)
- REST API Pairs: ✅ 100% реализовано (7/7 endpoints)
- REST API Stats: ✅ 100% реализовано (3/3 endpoints)
- REST API Settings: ✅ 100% реализовано (2/2 endpoints)
- REST API Notifications: ✅ 100% реализовано (3/3 endpoints)
- REST API Blacklist: ✅ 100% реализовано (3/3 endpoints)

**Frontend (React):**
- Структура файлов: ✅ 100% создано
- Базовая структура: ✅ 100% (package.json, tsconfig.json, типы)
- Сервисы: ✅ 100% (API клиент, WebSocket клиент)
- Хуки: ✅ 100% (usePairs, useExchanges, useWebSocket, useNotifications)
- Общие компоненты: ✅ 100% (Header с индикатором WebSocket, Navigation, BalanceBar)
- Вкладка БОТ: ✅ 100% (BotPage, PairCard, AddPairModal, EditPairModal, Blacklist)
- Вкладка API/STATS: ✅ 100% (APIStatsPage, ExchangeList, ExchangeCard, StatsOverview с WebSocket, TopPairs, EventsList)
- Вкладка Уведомления: ✅ 100% (NotificationsPage, NotificationFeed, NotificationFilters)
- Главное приложение: ✅ 100% (App с роутингом, index.tsx)
- Интеграция WebSocket: ✅ 100% (real-time обновления для пар, балансов, статистики, уведомлений)

**Мониторинг производительности:**
- Prometheus метрики: ✅ 100% реализовано (`internal/bot/metrics.go`)
- pprof endpoints: ✅ 100% реализовано (`internal/api/routes.go`)
- Alerting rules: ✅ 100% реализовано (`monitoring/alerts.yml`)
- Docker интеграция: ✅ Prometheus, Alertmanager, Grafana (`docker-compose.yml`)

**Тесты:**
- Crypto (pkg/crypto): ✅ 100% покрытие (encrypt_test.go, hash_test.go)
- Spread Calculator (internal/bot): ✅ 85-100% покрытие (spread_test.go: 35 тестов)
- State Machine (internal/bot): ✅ 100% покрытие (state_machine_test.go: 17 тестов + 4 бенчмарка)
- Репозитории (internal/repository): ✅ 73.9% покрытие (sqlmock тесты)
- Сервисы (internal/service): ✅ Unit тесты для всех сервисов (blacklist, settings, notification, stats, pair, exchange)

**Следующий шаг:** Unit тесты для handlers (Приоритет 10) или API документация (Приоритет 11)

---

