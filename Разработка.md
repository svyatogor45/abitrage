# План разработки арбитражного веб-терминала

## Обзор

Данный документ содержит пошаговый план разработки проекта, разбитый по приоритетам. План основан на документах **Архитектура.md** и **Тз.md**.

### Условные обозначения

| Символ | Значение |
|--------|----------|
| `[ ]` | Не начато |
| `[~]` | В процессе |
| `[x]` | Завершено |
| `[!]` | Заблокировано |

---

## Приоритет 1: Базовая инфраструктура (КРИТИЧЕСКИЙ)

> **Цель:** Создать фундамент проекта — конфигурация, БД, базовые модели и HTTP сервер.

### 1.1 Конфигурация и запуск

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Структура конфигурации | `internal/config/config.go` | Загрузка переменных окружения, валидация, значения по умолчанию |
| `[x]` | Пример .env файла | `.env.example` | Шаблон переменных окружения |
| `[x]` | Go модули | `go.mod` | Зависимости проекта |
| `[ ]` | Генерация go.sum | `go.sum` | Выполнить `go mod tidy` |

### 1.2 База данных и миграции

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Таблица exchanges | `migrations/001_*.sql` | Хранение API ключей бирж |
| `[x]` | Таблица pairs | `migrations/002_*.sql` | Конфигурация торговых пар |
| `[x]` | Таблица orders | `migrations/003_*.sql` | История ордеров |
| `[x]` | Таблица notifications | `migrations/004_*.sql` | Журнал уведомлений |
| `[x]` | Таблица settings | `migrations/005_*.sql` | Глобальные настройки |
| `[x]` | Таблица blacklist | `migrations/006_*.sql` | Черный список пар |
| `[x]` | Таблица trades | `migrations/007_*.sql` | Завершенные арбитражи (статистика) |

### 1.3 Модели данных

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeAccount | `internal/models/exchange_account.go` | Модель биржевого аккаунта |
| `[x]` | PairConfig | `internal/models/pair.go` | Конфигурация торговой пары |
| `[x]` | PairRuntime | `internal/models/pair_runtime.go` | Runtime состояние пары (Leg) |
| `[x]` | OrderRecord | `internal/models/order.go` | Запись об ордере |
| `[x]` | Notification | `internal/models/notification.go` | Уведомление о событии |
| `[x]` | Settings | `internal/models/settings.go` | Глобальные настройки |
| `[x]` | BlacklistEntry | `internal/models/blacklist.go` | Запись черного списка |
| `[x]` | Stats | `internal/models/stats.go` | Агрегированная статистика |

### 1.4 Точка входа и HTTP сервер

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Main функция | `cmd/server/main.go` | Инициализация, graceful shutdown |
| `[x]` | Маршрутизация | `internal/api/routes.go` | Регистрация всех HTTP маршрутов |
| `[x]` | CORS middleware | `internal/api/middleware/cors.go` | Настройка CORS заголовков |
| `[x]` | Logging middleware | `internal/api/middleware/logging.go` | Логирование HTTP запросов |
| `[x]` | Recovery middleware | `internal/api/middleware/recovery.go` | Восстановление после паники |
| `[x]` | Auth middleware | `internal/api/middleware/auth.go` | JWT аутентификация |

### 1.5 Docker и деплой

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Dockerfile | `Dockerfile` | Сборка Go приложения |
| `[x]` | Docker Compose | `docker-compose.yml` | Оркестрация сервисов |

---

## Приоритет 2: Утилиты и вспомогательные пакеты (ВЫСОКИЙ)

> **Цель:** Реализовать переиспользуемые библиотеки для шифрования, логирования, retry логики.

### 2.1 Криптография

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | AES-256 шифрование | `pkg/crypto/encrypt.go` | Encrypt/Decrypt для API ключей |
| `[x]` | Bcrypt хеширование | `pkg/crypto/hash.go` | Хеширование паролей |

### 2.2 Утилиты

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Математические функции | `pkg/utils/math.go` | RoundToLotSize, CalculateSpread, CalculateNetSpread |
| `[x]` | Логирование | `pkg/utils/logger.go` | Структурированное логирование (zap/logrus) |
| `[x]` | Работа со временем | `pkg/utils/time.go` | GetDayStart, GetWeekStart, GetMonthStart |
| `[x]` | Валидация | `pkg/utils/validator.go` | ValidateSymbol, ValidateSpread, ValidateVolume |

### 2.3 Retry и Rate Limiting

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Retry механизм | `pkg/retry/retry.go` | Экспоненциальный backoff (2s, 4s, 8s, 16s) |
| `[x]` | Rate limiter | `pkg/ratelimit/limiter.go` | Token Bucket для контроля частоты запросов |

---

## Приоритет 3: Интеграция с биржами (ВЫСОКИЙ)

> **Цель:** Реализовать унифицированный интерфейс для работы с биржами и коннекторы к каждой бирже.

### 3.1 Общий интерфейс

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Exchange interface | `internal/exchange/interface.go` | Унифицированный интерфейс (Connect, GetBalance, PlaceMarketOrder, etc.) |
| `[x]` | Exchange factory | `internal/exchange/factory.go` | NewExchange(name) - создание экземпляра биржи |

### 3.2 Реализации для бирж

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Bybit коннектор | `internal/exchange/bybit.go` | Bybit API v5, WebSocket |
| `[x]` | Bitget коннектор | `internal/exchange/bitget.go` | Bitget Futures API |
| `[x]` | OKX коннектор | `internal/exchange/okx.go` | OKX Futures API (+ passphrase) |
| `[x]` | Gate.io коннектор | `internal/exchange/gate.go` | Gate.io Futures API |
| `[x]` | HTX коннектор | `internal/exchange/htx.go` | HTX Linear Swaps API |
| `[x]` | BingX коннектор | `internal/exchange/bingx.go` | BingX Perpetual Futures API |

### 3.3 Функциональность каждого коннектора

Для каждой биржи (Bybit, Bitget, OKX, Gate.io, HTX, BingX) реализовано:

- [x] `Connect(apiKey, secret string) error` - подключение и проверка ключей
- [x] `GetBalance() (float64, error)` - получение equity в USDT
- [x] `GetTicker(symbol string) (Ticker, error)` - текущая цена
- [x] `GetOrderBook(symbol string, depth int) (OrderBook, error)` - стакан ордеров
- [x] `PlaceMarketOrder(symbol, side string, qty float64) (Order, error)` - рыночный ордер
- [x] `GetOpenPositions() ([]Position, error)` - открытые позиции
- [x] `ClosePosition(symbol, side string, qty float64) error` - закрытие позиции
- [x] `SubscribeTicker(symbol string, callback func(Ticker))` - WebSocket подписка
- [x] `GetTradingFee(symbol string) (float64, error)` - комиссия тейкера
- [x] `GetLimits(symbol string) (Limits, error)` - лимиты биржи (min/max)

---

## Приоритет 4: Репозитории (Data Access Layer) (ВЫСОКИЙ)

> **Цель:** Реализовать слой доступа к данным для всех сущностей.

### 4.1 CRUD репозитории

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeRepository | `internal/repository/exchange_repository.go` | CRUD для бирж, UpdateBalance |
| `[x]` | PairRepository | `internal/repository/pair_repository.go` | CRUD для пар, GetActive, UpdateStatus |
| `[x]` | OrderRepository | `internal/repository/order_repository.go` | CRUD для ордеров, GetByPairID |
| `[x]` | NotificationRepository | `internal/repository/notification_repository.go` | CRUD, GetByTypes, DeleteOlderThan |
| `[x]` | SettingsRepository | `internal/repository/settings_repository.go` | Get/Update настроек |
| `[x]` | BlacklistRepository | `internal/repository/blacklist_repository.go` | CRUD, Exists |
| `[x]` | StatsRepository | `internal/repository/stats_repository.go` | GetStats, RecordTrade, RecordStopLoss, RecordLiquidation |

### 4.2 Реализация методов репозиториев

Для каждого репозитория:
- [x] Реализовать SQL запросы
- [x] Обработка ошибок (sql.ErrNoRows, etc.)
- [x] Транзакционная поддержка где необходимо
- [ ] Тесты

---

## Приоритет 5: Сервисный слой (Бизнес-логика) (ВЫСОКИЙ)

> **Цель:** Реализовать бизнес-логику между API и репозиториями.

### 5.1 Сервисы

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeService | `internal/service/exchange_service.go` | ConnectExchange, DisconnectExchange, UpdateBalance |
| `[x]` | PairService | `internal/service/pair_service.go` | CreatePair, UpdatePair, StartPair, PausePair |
| `[x]` | StatsService | `internal/service/stats_service.go` | GetStats, ResetStats, RecordTradeCompletion |
| `[x]` | NotificationService | `internal/service/notification_service.go` | CreateNotification, GetNotifications, ClearNotifications |
| `[x]` | RiskService | `internal/service/risk_service.go` | CheckStopLoss, CheckMarginRequirement, HandleLiquidation |

### 5.2 Ключевая логика сервисов

**ExchangeService:**
- [x] Шифрование API ключей перед сохранением
- [x] Тестовое подключение при ConnectExchange
- [x] Остановка пар при DisconnectExchange

**PairService:**
- [ ] Валидация параметров (спреды > 0, объем > 0)
- [ ] Проверка доступности актива на ≥2 биржах
- [ ] Отложенное применение изменений при открытой позиции
- [ ] Принудительное закрытие при PausePair с forceClose=true

**NotificationService:**
- [ ] Проверка настроек уведомлений перед созданием
- [ ] Broadcast через WebSocket Hub

---

## Приоритет 6: REST API Handlers (ВЫСОКИЙ)

> **Цель:** Реализовать HTTP обработчики для всех endpoints.

### 6.1 Handlers

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | ExchangeHandler | `internal/api/handlers/exchange_handler.go` | POST/DELETE /exchanges/{name}/connect, GET /exchanges |
| `[x]` | PairHandler | `internal/api/handlers/pair_handler.go` | CRUD /pairs, /pairs/{id}/start, /pairs/{id}/pause |
| `[x]` | NotificationHandler | `internal/api/handlers/notification_handler.go` | GET/DELETE /notifications |
| `[x]` | StatsHandler | `internal/api/handlers/stats_handler.go` | GET /stats, POST /stats/reset |
| `[x]` | BlacklistHandler | `internal/api/handlers/blacklist_handler.go` | CRUD /blacklist |
| `[x]` | SettingsHandler | `internal/api/handlers/settings_handler.go` | GET/PATCH /settings |

### 6.2 Реализация endpoints

**Exchanges:**
- [ ] `POST /api/exchanges/{name}/connect` - подключение биржи
- [ ] `DELETE /api/exchanges/{name}/connect` - отключение биржи
- [ ] `GET /api/exchanges` - список бирж и статусов
- [ ] `GET /api/exchanges/{name}/balance` - обновление баланса

**Pairs:**
- [ ] `POST /api/pairs` - добавление пары
- [ ] `GET /api/pairs` - список всех пар
- [ ] `GET /api/pairs/{id}` - конкретная пара
- [ ] `PATCH /api/pairs/{id}` - редактирование пары
- [ ] `DELETE /api/pairs/{id}` - удаление пары
- [ ] `POST /api/pairs/{id}/start` - запуск мониторинга
- [ ] `POST /api/pairs/{id}/pause` - приостановка

**Notifications:**
- [ ] `GET /api/notifications` - список уведомлений
- [ ] `GET /api/notifications?types=open,close,error` - с фильтрацией
- [ ] `DELETE /api/notifications` - очистка журнала

**Stats:**
- [ ] `GET /api/stats` - агрегированная статистика
- [ ] `GET /api/stats/top-pairs` - топ-5 пар
- [ ] `POST /api/stats/reset` - сброс счетчиков

**Blacklist:**
- [ ] `GET /api/blacklist` - черный список
- [ ] `POST /api/blacklist` - добавление в ЧС
- [ ] `DELETE /api/blacklist/{symbol}` - удаление из ЧС

**Settings:**
- [ ] `GET /api/settings` - глобальные настройки
- [ ] `PATCH /api/settings` - обновление настроек

---

## Приоритет 7: WebSocket (ВЫСОКИЙ)

> **Цель:** Реализовать real-time коммуникацию между сервером и клиентами.

### 7.1 WebSocket инфраструктура

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | WebSocket Hub | `internal/websocket/hub.go` | Центральный менеджер соединений, broadcast |
| `[x]` | WebSocket Client | `internal/websocket/client.go` | Управление индивидуальным соединением |

### 7.2 Типы сообщений

- [ ] `pairUpdate` - обновление состояния пары (цены, PNL, спред) - каждую секунду
- [ ] `notification` - новое уведомление
- [ ] `balanceUpdate` - обновление баланса биржи - каждую минуту
- [ ] `statsUpdate` - обновление статистики

### 7.3 Функциональность

- [x] Регистрация/отмена регистрации клиентов
- [x] Ping/Pong для проверки живости соединения
- [x] Буферизация исходящих сообщений (оптимизировано: исправлен race condition)
- [x] Graceful закрытие соединений
- [ ] Обработка переподключений

> **Оптимизации:**
> - maxMessageSize увеличен с 512 до 65536 байт
> - Исправлен race condition в writePump при чтении из буфера
> - Увеличены ReadBufferSize/WriteBufferSize до 4096 байт

---

## Приоритет 8: Торговый движок (Бот) (КРИТИЧЕСКИЙ)

> **Цель:** Реализовать основную торговую логику арбитражного бота.

### 8.1 Core компоненты бота

| Статус | Задача | Файл | Описание |
|--------|--------|------|----------|
| `[x]` | Engine | `internal/bot/engine.go` | Главный event loop, координация |
| `[x]` | State Machine | `internal/bot/state_machine.go` | Состояния пары (PAUSED, READY, ENTERING, HOLDING, EXITING, ERROR) |
| `[x]` | Arbitrage | `internal/bot/arbitrage.go` | Логика принятия решений об арбитраже |
| `[x]` | Spread Calculator | `internal/bot/spread.go` | Расчет спреда с учетом комиссий |
| `[x]` | Order Executor | `internal/bot/order.go` | Исполнение ордеров на биржах |
| `[x]` | Position Manager | `internal/bot/position.go` | Сопровождение открытых позиций |
| `[x]` | Risk Manager | `internal/bot/risk.go` | SL, ликвидации, проверка маржи |
| `[x]` | Recovery | `internal/bot/recovery.go` | Восстановление после перезапуска |

### 8.2 Engine (Главный движок)

**Функциональность:**
- [x] Главный event loop (event-driven архитектура)
- [x] Обработка всех активных пар
- [x] Координация между компонентами
- [x] Периодическое обновление балансов (каждую минуту)
- [x] Graceful shutdown
- [x] Соблюдение лимита max_concurrent_trades

> **Оптимизации:**
> - Event-driven вместо polling (мгновенная реакция на цены)
> - Шардированный worker pool для параллельной обработки
> - sync.Map для lock-free доступа к pairsBySymbol
> - Atomic counter для activeArbs (без mutex)
> - broadcastPairStates оптимизирован (короткий RLock)

### 8.3 State Machine (Машина состояний)

**Состояния:**
```
PAUSED     → пара на паузе
READY      → мониторинг активен, ожидание условий
ENTERING   → процесс входа в позицию
HOLDING    → позиция открыта, ожидание выхода
EXITING    → процесс закрытия позиции
ERROR      → ошибка, требуется вмешательство
```

**Переходы:**
- [ ] PAUSED → READY (start)
- [ ] READY → ENTERING (условия входа выполнены)
- [ ] ENTERING → HOLDING (обе ноги открыты)
- [ ] ENTERING → PAUSED (ошибка второй ноги)
- [ ] HOLDING → EXITING (условия выхода)
- [ ] HOLDING → PAUSED (SL или ликвидация)
- [ ] EXITING → READY (успешное закрытие)
- [ ] Любое → ERROR → PAUSED

### 8.4 Spread Calculator (Расчет спреда)

**Функциональность:**
- [ ] Получение цен со всех подключенных бирж
- [ ] Анализ стакана ордеров (5 уровней глубины)
- [ ] Моделирование исполнения ордера заданного объема
- [ ] Расчет базового спреда: `(P_high - P_low) / P_low × 100`
- [ ] Учет комиссий тейкера на обеих биржах
- [ ] Расчет чистого спреда (net spread)
- [ ] Проверка достаточности ликвидности
- [ ] Кэширование данных стаканов

### 8.5 Arbitrage (Логика арбитража)

**Функциональность:**
- [ ] Определение арбитражных возможностей
- [ ] Выбор оптимальной пары бирж (min price / max price)
- [ ] Проверка условий входа: `net_spread ≥ entry_spread`
- [ ] Проверка условий выхода: `spread ≤ exit_spread`
- [ ] Логика частичного входа (разбиение на N ордеров)
- [ ] Координация одновременного открытия/закрытия позиций
- [ ] Обработка кейса "вторая нога не открылась"

### 8.6 Order Executor (Исполнение ордеров)

**Функциональность:**
- [ ] Формирование рыночных ордеров
- [ ] Одновременная отправка на две биржи (асинхронно)
- [ ] Ожидание подтверждения исполнения
- [ ] Получение средней цены исполнения (fill price)
- [ ] Обработка частичного исполнения
- [ ] Retry logic при ошибках API (до 4 попыток)
- [ ] Валидация размеров ордеров (min/max limits)
- [ ] Округление объемов до lot size биржи

### 8.7 Position Manager (Сопровождение позиций)

**Функциональность:**
- [x] Непрерывный мониторинг открытых позиций
- [x] Получение текущих цен для расчета unrealized PNL
- [x] Расчет PNL по каждой ноге: `(P_current - P_entry) × qty`
- [x] Суммирование PNL обеих ног арбитража
- [x] Отслеживание текущего спреда между позициями
- [x] Проверка условий для закрытия позиций
- [x] Обновление данных в WebSocket (каждую секунду)

### 8.8 Risk Manager (Управление рисками)

**Функциональность:**
- [x] Мониторинг Stop Loss: `total_PNL ≤ -SL`
- [x] Автоматическое закрытие при достижении SL
- [x] Обнаружение ликвидаций через WebSocket биржи
- [x] Экстренное закрытие второй ноги при ликвидации первой
- [ ] Автоматическая постановка пары на паузу после SL/ликвидации
- [ ] Проверка маржинальных требований перед входом
- [ ] Расчет margin requirement для позиции
- [ ] Генерация уведомлений о критических событиях

### 8.9 Recovery (Восстановление)

**Функциональность:**
- [ ] Чтение конфигурации из БД при старте
- [ ] Восстановление подключений к биржам
- [ ] Обнаружение открытых позиций через API бирж
- [ ] Попытка идентификации позиций бота
- [ ] Восстановление runtime состояния пар
- [ ] Уведомление пользователя о найденных позициях
- [ ] Опциональное автоматическое закрытие "потерянных" позиций

---

## Приоритет 9: Frontend (React) (СРЕДНИЙ)

> **Цель:** Создать веб-интерфейс для управления ботом.

### 9.1 Базовая структура

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[ ]` | Инициализация проекта | `frontend/` | Create React App или Vite с TypeScript |
| `[ ]` | package.json | `frontend/package.json` | Зависимости (React, TypeScript, Axios, etc.) |
| `[ ]` | tsconfig.json | `frontend/tsconfig.json` | Настройки TypeScript |
| `[ ]` | Типы | `frontend/src/types/index.ts` | TypeScript интерфейсы |

### 9.2 Сервисы

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[ ]` | API клиент | `frontend/src/services/api.ts` | Axios HTTP клиент |
| `[ ]` | WebSocket клиент | `frontend/src/services/websocket.ts` | Подключение к WS |

### 9.3 Хуки

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[ ]` | usePairs | `frontend/src/hooks/usePairs.ts` | Работа с парами |
| `[ ]` | useExchanges | `frontend/src/hooks/useExchanges.ts` | Работа с биржами |
| `[ ]` | useWebSocket | `frontend/src/hooks/useWebSocket.ts` | WebSocket соединение |
| `[ ]` | useNotifications | `frontend/src/hooks/useNotifications.ts` | Работа с уведомлениями |

### 9.4 Общие компоненты

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[ ]` | Header | `frontend/src/components/Common/Header.tsx` | Шапка приложения |
| `[ ]` | Navigation | `frontend/src/components/Common/Navigation.tsx` | Навигация по вкладкам |
| `[ ]` | BalanceBar | `frontend/src/components/Common/BalanceBar.tsx` | Балансы бирж |

### 9.5 Вкладка БОТ

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[ ]` | BotPage | `frontend/src/pages/BotPage.tsx` | Главная страница бота |
| `[ ]` | PairCard | `frontend/src/components/Bot/PairCard.tsx` | Карточка торговой пары |
| `[ ]` | AddPairModal | `frontend/src/components/Bot/AddPairModal.tsx` | Модальное окно добавления |
| `[ ]` | EditPairModal | `frontend/src/components/Bot/EditPairModal.tsx` | Редактирование пары |
| `[ ]` | Blacklist | `frontend/src/components/Bot/Blacklist.tsx` | Черный список |

**Функциональность PairCard:**
- [ ] Цветовая индикация (зеленый/оранжевый/белый)
- [ ] Отображение параметров (Р.О, С.В, С.ВЫ, N.ОР, SL)
- [ ] Текущие позиции (биржа, side, цена, PNL)
- [ ] Суммарный PNL по связке
- [ ] Кнопки: Старт/Пауза, Изменить, Удалить
- [ ] Обновление данных каждую секунду

### 9.6 Вкладка API/STATS

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[ ]` | APIStatsPage | `frontend/src/pages/APIStatsPage.tsx` | Страница API и статистики |
| `[ ]` | ExchangeList | `frontend/src/components/API/ExchangeList.tsx` | Список бирж |
| `[ ]` | ExchangeCard | `frontend/src/components/API/ExchangeCard.tsx` | Карточка биржи |
| `[ ]` | StatsOverview | `frontend/src/components/Stats/StatsOverview.tsx` | Обзор статистики |
| `[ ]` | TopPairs | `frontend/src/components/Stats/TopPairs.tsx` | Топ-5 пар |
| `[ ]` | EventsList | `frontend/src/components/Stats/EventsList.tsx` | Список SL/ликвидаций |

**Функциональность ExchangeCard:**
- [ ] Логотип биржи
- [ ] Статус подключения (зеленый/красный)
- [ ] Поля для API Key и Secret
- [ ] Кнопки: Подключить/Изменить/Отключить
- [ ] Отображение баланса (equity)

**Функциональность StatsOverview:**
- [ ] Количество сделок (день/неделя/месяц)
- [ ] Общий PNL (день/неделя/месяц)
- [ ] Счетчик SL (с деталями)
- [ ] Счетчик ликвидаций (с деталями)
- [ ] Кнопки сброса счетчиков

### 9.7 Вкладка Уведомления

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[ ]` | NotificationsPage | `frontend/src/pages/NotificationsPage.tsx` | Страница уведомлений |
| `[ ]` | NotificationFeed | `frontend/src/components/Notifications/NotificationFeed.tsx` | Лента уведомлений |
| `[ ]` | NotificationFilters | `frontend/src/components/Notifications/NotificationFilters.tsx` | Фильтры по типам |

**Типы уведомлений:**
- [ ] OPEN - открытие сделки (зеленый)
- [ ] CLOSE - закрытие сделки (зеленый)
- [ ] SL - Stop Loss (красный)
- [ ] LIQUIDATION - ликвидация (красный)
- [ ] ERROR - ошибка API (красный)
- [ ] MARGIN - недостаток маржи (желтый)
- [ ] PAUSE - пауза/остановка (желтый)
- [ ] SECOND_LEG_FAIL - вторая нога не открыта (красный)

### 9.8 Главное приложение

| Статус | Задача | Путь | Описание |
|--------|--------|------|----------|
| `[ ]` | App | `frontend/src/App.tsx` | Главный компонент с роутингом |
| `[ ]` | index | `frontend/src/index.tsx` | Точка входа |

---

## Приоритет 10: Тестирование (СРЕДНИЙ)

> **Цель:** Обеспечить качество кода через тестирование.

### 10.1 Unit тесты

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | Тесты моделей | Валидация структур данных |
| `[ ]` | Тесты репозиториев | Mock БД, CRUD операции |
| `[ ]` | Тесты сервисов | Mock репозиториев |
| `[ ]` | Тесты handlers | Mock сервисов, HTTP запросы |
| `[ ]` | Тесты spread calculator | Расчет спреда с разными данными |
| `[ ]` | Тесты state machine | Переходы между состояниями |
| `[ ]` | Тесты crypto | Шифрование/дешифрование |

### 10.2 Интеграционные тесты

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | API integration tests | Полный цикл запросов |
| `[ ]` | WebSocket tests | Подключение, broadcast |
| `[ ]` | Database tests | Миграции, транзакции |

### 10.3 E2E тесты (опционально)

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | Cypress/Playwright | Тестирование UI |
| `[ ]` | Сценарии пользователя | Добавление пары, старт/пауза |

---

## Приоритет 11: Документация и финализация (НИЗКИЙ)

> **Цель:** Документирование и подготовка к production.

### 11.1 Документация

| Статус | Задача | Описание |
|--------|--------|----------|
| `[x]` | README.md | Описание проекта, инструкции запуска |
| `[x]` | Архитектура.md | Архитектурная документация |
| `[ ]` | API документация | Swagger/OpenAPI спецификация |
| `[ ]` | Руководство пользователя | Как пользоваться терминалом |

### 11.2 Production готовность

| Статус | Задача | Описание |
|--------|--------|----------|
| `[ ]` | SSL/TLS сертификаты | HTTPS настройка |
| `[ ]` | Nginx reverse proxy | Production конфигурация |
| `[ ]` | Мониторинг и алерты | Prometheus/Grafana (опционально) |
| `[ ]` | Backup стратегия | Резервное копирование БД |
| `[ ]` | Rate limit tuning | Настройка лимитов для каждой биржи |

---

## Порядок выполнения (Roadmap)

### Фаза 1: Фундамент (1-2 недели)
1. ✅ Приоритет 1 (Базовая инфраструктура)
2. ✅ Приоритет 2 (Утилиты)
3. ✅ Приоритет 3.1 (Интерфейс бирж)

### Фаза 2: Backend Core (2-3 недели)
4. Приоритет 3.2 (Реализации коннекторов бирж)
5. Приоритет 4 (Репозитории - реализация SQL)
6. Приоритет 5 (Сервисный слой - реализация логики)
7. Приоритет 6 (REST API - реализация endpoints)

### Фаза 3: Торговый движок (2-3 недели)
8. Приоритет 7 (WebSocket)
9. Приоритет 8 (Торговый движок - Bot)

### Фаза 4: Frontend (2-3 недели)
10. Приоритет 9 (React приложение)

### Фаза 5: Тестирование и релиз (1-2 недели)
11. Приоритет 10 (Тестирование)
12. Приоритет 11 (Документация и production)

---

## Зависимости между компонентами

```
Config → Models → Repositories → Services → Handlers → Routes
                      ↓
                  Bot Engine
                      ↓
              Exchange Connectors
                      ↓
                WebSocket Hub → Frontend
```

---

## Критические пути

1. **Exchange Connectors** - без них невозможна торговля
2. **Bot Engine** - ядро системы
3. **WebSocket** - real-time обновления для UI
4. **State Machine** - корректные переходы между состояниями

---

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| API биржи изменился | Средняя | Высокое | Версионирование, мониторинг изменений |
| Rate limits превышены | Высокая | Среднее | Rate limiter, кэширование |
| Потеря соединения | Высокая | Высокое | Retry logic, reconnect, graceful degradation |
| Ликвидация позиции | Низкая | Критическое | Risk manager, уведомления, автозакрытие |
| Сбой сервера | Низкая | Критическое | Recovery механизм, логирование состояний |

---

## Чеклист перед релизом

- [ ] Все миграции применены
- [ ] go.sum сгенерирован (`go mod tidy`)
- [ ] Все тесты проходят
- [ ] API ключи шифруются
- [ ] HTTPS настроен
- [ ] Логирование работает
- [ ] WebSocket стабилен
- [ ] Recovery протестирован
- [ ] Документация актуальна
- [ ] Docker образы собираются
- [ ] Frontend собирается для production

---

## Текущий статус проекта

**Backend (Go):**
- Структура файлов: ✅ 100% создано
- Коннекторы бирж: ✅ 100% реализовано (Bybit, Bitget, OKX, Gate.io, HTX, BingX)
- Репозитории: ✅ 100% реализовано (SQL запросы, обработка ошибок)
- ExchangeService: ✅ 100% реализовано (шифрование, подключение, отключение)
- Остальные сервисы: ⏳ Частично реализовано

**Frontend (React):**
- Структура файлов: ❌ 0% (директория не создана)
- Реализация: ❌ Не начато

**Следующий шаг:** Реализация PairService/NotificationService (Приоритет 5.2) или компонентов торгового движка (Приоритет 8.3-8.6)

---

## История оптимизаций

### 2025-12-01: Реализация ExchangeService (Приоритет 5.2)

**Реализовано:**

1. **AES-256-GCM шифрование** (`pkg/crypto/encrypt.go`)
   - Encrypt/Decrypt функции с base64 кодированием
   - GenerateKey для генерации криптографически стойких ключей
   - Валидация длины ключа (32 байта для AES-256)
   - EncryptWithKeyString/DecryptWithKeyString для удобства

2. **ExchangeService** (`internal/service/exchange_service.go`)
   - **ConnectExchange**:
     * Проверка поддержки биржи
     * Тестовое подключение к API (валидация ключей)
     * Получение баланса для проверки работоспособности
     * Шифрование API ключей перед сохранением в БД
     * Кэширование активных соединений
   - **DisconnectExchange**:
     * Проверка наличия подключения
     * Остановка всех активных пар (если останется < 2 бирж)
     * Очистка ключей из БД
     * Закрытие соединений
   - **UpdateBalance**: запрос баланса через API, обновление в БД
   - **GetAllExchanges**: список всех бирж без API ключей
   - **GetConnection**: получение активного соединения для торгового движка
   - **UpdateAllBalances**: массовое обновление балансов
   - **HasMinimumExchanges**: проверка минимума для арбитража (≥2)

---

### 2025-12-01: Реализация методов репозиториев (Приоритет 4.2)

**Реализовано для всех 7 репозиториев:**

1. **ExchangeRepository** (`internal/repository/exchange_repository.go`)
   - Create, GetByID, GetByName, GetAll, GetConnected
   - Update, Delete, DeleteByName
   - UpdateBalance, UpdateBalanceByName, SetConnected, SetLastError
   - CountConnected
   - Обработка sql.ErrNoRows → ErrExchangeNotFound
   - Обработка unique violation → ErrExchangeExists

2. **PairRepository** (`internal/repository/pair_repository.go`)
   - Create, GetByID, GetBySymbol, GetAll, GetActive, GetPaused
   - Update, UpdateParams, Delete
   - UpdateStatus, IncrementTrades, UpdatePnl, ResetStats
   - Count, CountActive, ExistsBySymbol, Search

3. **OrderRepository** (`internal/repository/order_repository.go`)
   - Create, GetByID, GetByPairID, GetRecent
   - GetByStatus, GetByExchange
   - UpdateStatus, SetError, Delete, DeleteByPairID
   - DeleteOlderThan, Count, CountByStatus
   - GetFilledByPairIDInTimeRange

4. **NotificationRepository** (`internal/repository/notification_repository.go`)
   - Create, GetByID, GetRecent, GetByTypes
   - GetByPairID, GetBySeverity, GetInTimeRange
   - DeleteAll, DeleteOlderThan, DeleteByPairID
   - Count, CountByType, CountBySeverity, KeepRecent
   - JSON сериализация/десериализация поля meta

5. **SettingsRepository** (`internal/repository/settings_repository.go`)
   - Get (с автосозданием дефолтной записи)
   - Update, UpdateNotificationPrefs
   - UpdateConsiderFunding, UpdateMaxConcurrentTrades
   - GetNotificationPrefs, GetMaxConcurrentTrades
   - ResetToDefaults
   - JSON сериализация NotificationPreferences

6. **BlacklistRepository** (`internal/repository/blacklist_repository.go`)
   - Create, GetAll, GetByID, GetBySymbol
   - Delete, DeleteByID, Exists
   - UpdateReason, Count, DeleteAll, Search
   - Автоматическое приведение символов к верхнему регистру

7. **StatsRepository** (`internal/repository/stats_repository.go`)
   - RecordTrade с поддержкой was_stop_loss и was_liquidation
   - GetStats (агрегация по день/неделя/месяц)
   - GetTopPairsByTrades, GetTopPairsByProfit, GetTopPairsByLoss
   - ResetCounters, DeleteOlderThan
   - GetTradesByPairID, GetTradesInTimeRange
   - Count, GetPNLBySymbol

**Исправлено:**

8. **Position Manager StopLoss** (`internal/bot/position.go:176-180`)
   - Было: ps.Config.StopLossPct (несуществующее поле)
   - Стало: ps.Config.StopLoss (абсолютное значение в USDT)

---

### 2025-12-01: Реализация коннекторов бирж (Приоритет 3.3)

**Реализовано для всех 6 бирж (Bybit, Bitget, OKX, Gate.io, HTX, BingX):**

1. **REST API клиенты:**
   - HMAC-SHA256/SHA512 подписи запросов
   - Получение баланса (equity в USDT)
   - Получение тикеров (bid/ask/last price)
   - Получение стакана ордеров
   - Размещение рыночных ордеров
   - Получение открытых позиций
   - Закрытие позиций
   - Получение комиссий тейкера
   - Получение лимитов инструментов

2. **WebSocket клиенты:**
   - Публичные подписки на тикеры
   - Приватные подписки на позиции (где поддерживается)
   - Автоматическая аутентификация
   - Потокобезопасная обработка callbacks

3. **Конвертация символов:**
   - Bybit: BTCUSDT (прямой формат)
   - Bitget: BTCUSDT (прямой формат)
   - OKX: BTC-USDT-SWAP
   - Gate.io: BTC_USDT
   - HTX: BTC-USDT
   - BingX: BTC-USDT

---

### 2024-XX-XX: Оптимизация bottlenecks торгового ядра

**Реализовано:**

1. **Rate Limiter** (`pkg/ratelimit/limiter.go`)
   - Token Bucket алгоритм с поддержкой burst
   - Методы: Wait (блокирующий), Allow (неблокирующий), Reserve
   - MultiLimiter для разных категорий запросов
   - Потокобезопасная реализация

2. **Retry Logic** (`pkg/retry/retry.go`)
   - Exponential backoff с jitter
   - Конфигурации: Default, Aggressive, Conservative, Network
   - Generic DoWithResult для операций с результатом
   - Wrapper'ы: Permanent (не retry), Temporary (retry)

3. **Position Manager** (`internal/bot/position.go`)
   - Мониторинг открытых позиций
   - Расчет PNL по каждой ноге
   - Проверка условий выхода (exit spread)
   - Проверка Stop Loss
   - Обработка ликвидаций

**Исправлено:**

4. **WebSocket race condition** (`internal/websocket/client.go:130-150`)
   - Было: `n := len(c.send); for i < n { <-c.send }`
   - Стало: non-blocking select в цикле drainLoop

5. **maxMessageSize** (`internal/websocket/client.go:22`)
   - Было: 512 байт (слишком мало для JSON)
   - Стало: 65536 байт (64KB)

6. **broadcastPairStates RLock** (`internal/bot/engine.go:427-458`)
   - Было: RLock на весь цикл broadcast (300-900ms)
   - Стало: RLock только на копирование (~1ms)
