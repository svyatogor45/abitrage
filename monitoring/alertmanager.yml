# Конфигурация Alertmanager для арбитражного бота
#
# Документация: https://prometheus.io/docs/alerting/latest/configuration/
#
# Alertmanager отвечает за:
# - Группировку алертов
# - Подавление повторяющихся уведомлений
# - Маршрутизацию уведомлений в разные каналы
# - Интеграцию с Telegram, Slack, Email и др.

global:
  # Интервал повторной отправки уведомления (если алерт не разрешён)
  resolve_timeout: 5m

  # Настройки SMTP для email уведомлений
  # smtp_smarthost: 'smtp.gmail.com:587'
  # smtp_from: 'alertmanager@example.com'
  # smtp_auth_username: 'your-email@gmail.com'
  # smtp_auth_password: 'your-app-password'

# Шаблоны уведомлений
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Маршрутизация алертов
route:
  # Группировка по имени алерта и компоненту
  group_by: ['alertname', 'component']

  # Время ожидания перед отправкой группы алертов
  group_wait: 30s

  # Интервал между отправками новых алертов в группе
  group_interval: 5m

  # Интервал повторной отправки (если алерт активен)
  repeat_interval: 4h

  # Receiver по умолчанию
  receiver: 'default-receiver'

  # Дочерние маршруты для разных severity
  routes:
    # Критические алерты - немедленно
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h

    # Warning алерты
    - match:
        severity: warning
      receiver: 'warning-receiver'
      group_wait: 1m
      repeat_interval: 4h

    # Info алерты (низкий приоритет)
    - match:
        severity: info
      receiver: 'info-receiver'
      group_wait: 5m
      repeat_interval: 12h

# Получатели уведомлений
receivers:
  # Default receiver (консольный вывод для development)
  - name: 'default-receiver'
    webhook_configs:
      - url: 'http://app:8080/api/v1/notifications/webhook'
        send_resolved: true

  # Критические алерты
  - name: 'critical-receiver'
    webhook_configs:
      - url: 'http://app:8080/api/v1/notifications/webhook'
        send_resolved: true

    # Telegram (раскомментировать и настроить)
    # telegram_configs:
    #   - bot_token: 'YOUR_BOT_TOKEN'
    #     chat_id: YOUR_CHAT_ID
    #     parse_mode: 'HTML'
    #     message: |
    #       {{ range .Alerts }}
    #       <b>{{ .Status | toUpper }}</b>: {{ .Labels.alertname }}
    #       {{ .Annotations.summary }}
    #       {{ .Annotations.description }}
    #       {{ end }}

  # Warning алерты
  - name: 'warning-receiver'
    webhook_configs:
      - url: 'http://app:8080/api/v1/notifications/webhook'
        send_resolved: true

  # Info алерты
  - name: 'info-receiver'
    webhook_configs:
      - url: 'http://app:8080/api/v1/notifications/webhook'
        send_resolved: true

# Подавление алертов (inhibition rules)
inhibit_rules:
  # Подавить warning если есть critical с тем же alertname
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'component']

  # Подавить алерты о парах если биржа отключена
  - source_match:
      alertname: 'ExchangeDisconnected'
    target_match:
      component: 'pair_manager'
    equal: ['exchange']
