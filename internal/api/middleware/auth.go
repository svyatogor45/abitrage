package middleware

import (
	"net/http"
)

// Auth - middleware для аутентификации и авторизации запросов
//
// Назначение:
// Проверяет наличие и валидность токенов аутентификации (JWT или session cookie).
// Защищает API endpoints от неавторизованного доступа.
// Извлекает информацию о пользователе из токена и добавляет в context запроса.
//
// Функции:
// - Проверка JWT токенов из заголовка Authorization
// - Валидация подписи и срока действия токена
// - Извлечение user_id из токена
// - Добавление user_id в request context для использования в handlers
// - Возврат 401 Unauthorized при отсутствии или невалидном токене
// - Rate limiting для предотвращения bruteforce атак
//
// Примечание:
// В первой версии проекта (один пользователь) может быть упрощенная версия
// с базовой проверкой пароля или без auth вообще (для локального развертывания)
func Auth(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		// TODO:
		// 1. Извлечь токен из заголовка Authorization: Bearer <token>
		// 2. Если токена нет - вернуть 401 Unauthorized
		// 3. Валидировать JWT токен:
		//    - Проверить подпись (используя JWT_SECRET из config)
		//    - Проверить срок действия (exp claim)
		// 4. Извлечь claims из токена (user_id, роль)
		// 5. Добавить информацию в context запроса
		// 6. Передать управление следующему handler

		// Временная реализация: пропускать все запросы (для разработки)
		next.ServeHTTP(w, r)
	})
}

// OptionalAuth - опциональная аутентификация
//
// Назначение:
// Проверяет токен если он предоставлен, но не требует его наличия.
// Используется для endpoints, которые могут работать как для авторизованных,
// так и для неавторизованных пользователей.
func OptionalAuth(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		// TODO:
		// 1. Попытаться извлечь токен из заголовка
		// 2. Если токен есть - валидировать и добавить в context
		// 3. Если токена нет или невалидный - продолжить без auth
		// 4. Передать управление следующему handler

		next.ServeHTTP(w, r)
	})
}
